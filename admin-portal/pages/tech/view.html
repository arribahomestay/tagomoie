<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/content.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Technician Dashboard</title>
</head>

<body>
    <div class="content-header"
        style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
        <div>
            <h1 class="page-title" style="font-size: 2rem; margin-bottom: 0.5rem;">Admin Management</h1>
            <p class="page-subtitle" style="color: var(--text-secondary);">Manage system administrators and department
                assignments</p>
        </div>

        <button onclick="openAddAdminModal()"
            style="background: #4f46e5; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); transition: all 0.2s;">
            <div
                style="background: rgba(255,255,255,0.2); width: 20px; height: 20px; border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="plus" width="14" stroke-width="3"></i>
            </div>
            New Administrator
        </button>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 2.5rem; gap: 1.5rem;">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                <i data-lucide="shield"></i>
            </div>
            <div>
                <div class="stat-value" id="total-admins">0</div>
                <div class="stat-label">Total Admins</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <i data-lucide="building-2"></i>
            </div>
            <div>
                <div class="stat-value" id="total-depts">0</div>
                <div class="stat-label">Departments</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <i data-lucide="users"></i>
            </div>
            <div>
                <div class="stat-value" id="total-staff">0</div>
                <div class="stat-label">Total Staff</div>
            </div>
        </div>
    </div>

    <!-- Admins Table -->
    <div class="table-container"
        style="background: #1e293b; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden;">
        <table class="data-table">
            <thead>
                <tr style="background: rgba(255,255,255,0.02);">
                    <th style="color: #94a3b8; font-weight: 600; padding: 1.25rem;">Admin User</th>
                    <th style="color: #94a3b8; font-weight: 600;">Role</th>
                    <th style="color: #94a3b8; font-weight: 600;">Assigned Department</th>
                    <th style="color: #94a3b8; font-weight: 600;">Status</th>
                    <th style="color: #94a3b8; font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody id="admin-table-body">
                <!-- Populated via JS -->
            </tbody>
        </table>
    </div>

    <!-- Add Admin Modal (Modernized) -->
    <div class="modal-overlay" id="addAdminModal"
        style="backdrop-filter: blur(12px); background: rgba(0,0,0,0.02); transition: opacity 0.3s ease;">
        <div class="modal-card"
            style="background: #1e293b; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); color: #f8fafc; max-width: 600px; width: 95%; border-radius: 20px; padding: 2.5rem; transform: scale(0.95); transition: transform 0.3s ease;">

            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                <div>
                    <h2 style="font-size: 1.75rem; font-weight: 700; margin: 0; color: #fff;">Create Admin Account</h2>
                    <p style="color: #94a3b8; font-size: 0.95rem; margin-top: 0.5rem;">Fill in the details to register a
                        new system administrator.</p>
                </div>
                <button onclick="closeAddAdminModal()"
                    style="background: rgba(255,255,255,0.05); border: none; color: #94a3b8; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>

            <form id="add-admin-form" onsubmit="handleCreateAdmin(event)"
                style="display: flex; flex-direction: column; gap: 1.25rem;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="min-width: 0;">
                        <label class="form-label"
                            style="color: #cbd5e1; font-weight: 500; margin-bottom: 0.5rem; display: block;">First
                            Name</label>
                        <input type="text" id="a-fname" required
                            style="width: 100%; padding: 0.9rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; outline: none; transition: border 0.2s; box-sizing: border-box;"
                            placeholder="e.g. John">
                    </div>
                    <div style="min-width: 0;">
                        <label class="form-label"
                            style="color: #cbd5e1; font-weight: 500; margin-bottom: 0.5rem; display: block;">Last
                            Name</label>
                        <input type="text" id="a-lname" required
                            style="width: 100%; padding: 0.9rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; outline: none; box-sizing: border-box;"
                            placeholder="e.g. Doe">
                    </div>
                </div>

                <div>
                    <label class="form-label"
                        style="color: #cbd5e1; font-weight: 500; margin-bottom: 0.5rem; display: block;">Email
                        Address</label>
                    <div style="position: relative;">
                        <input type="email" id="a-email" required
                            style="width: 100%; padding: 0.9rem 0.9rem 0.9rem 2.75rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; outline: none; box-sizing: border-box;"
                            placeholder="admin@example.com">
                        <i data-lucide="mail" width="18"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div style="min-width: 0;">
                        <label class="form-label"
                            style="color: #cbd5e1; font-weight: 500; margin-bottom: 0.5rem; display: block;">Username</label>
                        <div style="position: relative;">
                            <input type="text" id="a-username" required
                                style="width: 100%; padding: 0.9rem 0.9rem 0.9rem 2.75rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; outline: none; box-sizing: border-box;"
                                placeholder="johndoe">
                            <i data-lucide="user" width="18"
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                        </div>
                    </div>
                    <div style="min-width: 0;">
                        <label class="form-label"
                            style="color: #cbd5e1; font-weight: 500; margin-bottom: 0.5rem; display: block;">Password</label>
                        <div style="position: relative;">
                            <input type="password" id="a-password" required
                                style="width: 100%; padding: 0.9rem 0.9rem 0.9rem 2.75rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; outline: none; box-sizing: border-box;"
                                placeholder="••••••••">
                            <i data-lucide="lock" width="18"
                                style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="form-label"
                        style="color: #cbd5e1; font-weight: 500; margin-bottom: 0.5rem; display: block;">Assign
                        Department</label>
                    <div style="position: relative;">
                        <select id="a-dept" required
                            style="width: 100%; padding: 0.9rem 2.5rem 0.9rem 2.75rem; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; appearance: none; outline: none; box-sizing: border-box;">
                            <option value="">Select Department...</option>
                            <!-- Populated via JS -->
                        </select>
                        <i data-lucide="building-2" width="18"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                        <i data-lucide="chevron-down" width="18"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: #64748b; pointer-events: none;"></i>
                    </div>
                </div>

                <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1.5fr; gap: 1rem;">
                    <button type="button" onclick="closeAddAdminModal()"
                        style="background: transparent; border: 1px solid #334155; color: #cbd5e1; padding: 0.9rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        Cancel
                    </button>
                    <button type="submit"
                        style="background: #4f46e5; color: white; border: none; padding: 0.9rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);">
                        <i data-lucide="user-plus" width="18"></i>
                        Create Account
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Admin Department Modal (Refined) -->
    <div class="modal-overlay" id="editAdminModal"
        style="backdrop-filter: blur(12px); background: rgba(0,0,0,0.02); transition: opacity 0.3s ease;">
        <div class="modal-card"
            style="background: #1e293b; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); color: #f8fafc; max-width: 480px; width: 90%; border-radius: 16px; padding: 2rem; transform: scale(0.95); transition: transform 0.3s ease;">

            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                <div>
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: #fff;">Edit Assignment</h2>
                    <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 0.25rem;">Update department access for this
                        administrator.</p>
                </div>
                <button onclick="closeEditAdminModal()"
                    style="background: rgba(255,255,255,0.05); border: none; color: #94a3b8; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <i data-lucide="x" width="18"></i>
                </button>
            </div>

            <form id="edit-admin-form" onsubmit="handleUpdateDepartment(event)"
                style="display: flex; flex-direction: column; gap: 1.5rem;">
                <input type="hidden" id="e-admin-id">

                <!-- Admin Info Field -->
                <div
                    style="background: rgba(99, 102, 241, 0.05); padding: 1rem; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.2); display: flex; gap: 1rem; align-items: center;">
                    <div
                        style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #818cf8;">
                        <i data-lucide="user-check" width="20"></i>
                    </div>
                    <div>
                        <div
                            style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: #818cf8; font-weight: 600;">
                            Selected Admin</div>
                        <input type="text" id="e-admin-name" disabled
                            style="background: transparent; border: none; font-size: 1rem; font-weight: 600; color: #e2e8f0; width: 100%; outline: none;">
                    </div>
                </div>

                <!-- Department Select -->
                <div>
                    <label
                        style="display: block; font-size: 0.9rem; font-weight: 500; color: #cbd5e1; margin-bottom: 0.75rem;">Assign
                        New Department</label>
                    <div style="position: relative;">
                        <select id="e-dept" required
                            style="width: 100%; padding: 1rem 1rem 1rem 3rem; background: #0f172a; border: 1px solid #334155; color: #fff; border-radius: 12px; font-size: 0.95rem; appearance: none; outline: none; transition: border-color 0.2s;">
                            <option value="">Select Department...</option>
                            <!-- Populated via JS -->
                        </select>
                        <i data-lucide="building-2" width="18"
                            style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b;"></i>
                        <i data-lucide="chevron-down" width="18"
                            style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); pointer-events: none; color: #64748b;"></i>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div style="margin-top: 1rem; display: grid; grid-template-columns: 1fr 1.5fr; gap: 1rem;">
                    <button type="button" onclick="closeEditAdminModal()"
                        style="background: transparent; border: 1px solid #334155; color: #cbd5e1; padding: 0.8rem; border-radius: 10px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                        Cancel
                    </button>
                    <button type="submit"
                        style="background: #6366f1; color: white; border: none; padding: 0.8rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);">
                        <i data-lucide="check" width="18"></i>
                        Confirm Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const API_BASE_URL = (window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:')
            ? 'http://localhost:3000'
            : '';

        async function fetchTechData() {
            try {
                // Fetch Departments for select
                const deptRes = await fetch(`${API_BASE_URL}/api/departments`);
                const departments = await deptRes.json();

                const deptSelect = document.getElementById('a-dept');
                deptSelect.innerHTML = '<option value="">Select Department...</option>';
                if (departments.length > 0) {
                    departments.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.innerText = d.department_name;
                        deptSelect.appendChild(opt);
                    });
                    document.getElementById('total-depts').innerText = departments.length;
                } else {
                    document.getElementById('total-depts').innerText = "0";
                }

                // Fetch Staff Count
                const staffRes = await fetch(`${API_BASE_URL}/api/stats/staff`);
                if (staffRes.ok) {
                    const staffData = await staffRes.json();
                    document.getElementById('total-staff').innerText = staffData.count;
                }

                // Fetch Admins
                const adminRes = await fetch(`${API_BASE_URL}/api/users/admins`);
                const admins = await adminRes.json();

                const tbody = document.getElementById('admin-table-body');
                tbody.innerHTML = '';
                document.getElementById('total-admins').innerText = admins.length;

                if (admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No admin accounts found.</td></tr>';
                } else {
                    admins.forEach(admin => {
                        const isDeactivated = admin.status === 'deactivated';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <div style="width: 32px; height: 32px; background: #e0e7ff; color: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem;">
                                            ${admin.initials}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${admin.full_name}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">@${admin.username}</div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="status-badge status-review" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">${admin.role}</span></td>
                                <td>${admin.department_name || '<span style="color: var(--text-secondary); font-style: italic;">Unassigned</span>'}</td>
                                <td>
                                    ${isDeactivated
                                ? '<span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">Deactivated</span>'
                                : '<span class="status-badge status-resolved">Active</span>'}
                                </td>
                                <td>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button onclick="openEditAdminModal(${admin.id}, '${admin.full_name.replace(/'/g, "\\'")}', '${admin.department_id || ''}')" 
                                            style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(59, 130, 246, 0.2)'" 
                                            onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'"
                                            title="Edit Department">
                                            <i data-lucide="pencil" width="14" stroke-width="2.5"></i>
                                        </button>

                                        <button onclick="toggleStatus(${admin.id}, '${isDeactivated ? 'active' : 'deactivated'}')"
                                            style="background: ${isDeactivated ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; color: ${isDeactivated ? '#10b981' : '#f59e0b'}; border: 1px solid ${isDeactivated ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}; width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='${isDeactivated ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}'" 
                                            onmouseout="this.style.background='${isDeactivated ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}'"
                                            title="${isDeactivated ? 'Activate Account' : 'Deactivate Account'}">
                                            <i data-lucide="${isDeactivated ? 'power' : 'ban'}" width="14" stroke-width="2.5"></i>
                                        </button>

                                        <button onclick="deleteAdmin(${admin.id})"
                                            style="background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" 
                                            onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'"
                                            title="Delete Admin">
                                            <i data-lucide="trash-2" width="14" stroke-width="2.5"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        tbody.appendChild(tr);
                    });
                }
                lucide.createIcons();

            } catch (err) {
                console.error('Error fetching data:', err);
            }
        }

        async function toggleStatus(id, newStatus) {
            if (confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this account?`)) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/users/${id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    if (res.ok) {
                        fetchTechData();
                    } else {
                        alert('Failed to update status');
                    }
                } catch (e) { console.error(e); }
            }
        }

        async function handleCreateAdmin(e) {
            e.preventDefault();
            const password = document.getElementById('a-password').value;

            // Client-side Password Validation
            const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
            if (!passwordRegex.test(password)) {
                alert('Password Weak:\n- At least 8 characters\n- Include a letter\n- Include a number\n- Include a special character (@$!%*#?&)');
                return;
            }

            const data = {
                first_name: document.getElementById('a-fname').value,
                last_name: document.getElementById('a-lname').value,
                email: document.getElementById('a-email').value,
                username: document.getElementById('a-username').value,
                password: password,
                department_id: document.getElementById('a-dept').value
            };

            try {
                const res = await fetch(`${API_BASE_URL}/api/users/admins`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('Admin created successfully!');
                    closeAddAdminModal();
                    fetchTechData();
                    e.target.reset();
                } else {
                    const err = await res.json();
                    // Alert the specific error from backend (e.g. "Username is already taken.")
                    alert(err.error);
                }
            } catch (err) {
                console.error(err);
                alert('Connection error');
            }
        }

        // --- Edit Modal Logic ---
        function openEditAdminModal(id, name, currentDeptId) {
            document.getElementById('e-admin-id').value = id;
            document.getElementById('e-admin-name').value = name;

            // Populate Dropdown copy from main one or re-fetch (simplest is copy options from Add Modal)
            const sourceSelect = document.getElementById('a-dept');
            const targetSelect = document.getElementById('e-dept');
            targetSelect.innerHTML = sourceSelect.innerHTML;
            targetSelect.value = currentDeptId;

            document.getElementById('editAdminModal').classList.add('active');
        }

        function closeEditAdminModal() {
            document.getElementById('editAdminModal').classList.remove('active');
        }

        async function handleUpdateDepartment(e) {
            e.preventDefault();
            const id = document.getElementById('e-admin-id').value;
            const deptId = document.getElementById('e-dept').value;

            try {
                const res = await fetch(`${API_BASE_URL}/api/users/${id}/department`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ department_id: deptId })
                });

                if (res.ok) {
                    alert('Department updated successfully!');
                    closeEditAdminModal();
                    fetchTechData();
                } else {
                    const err = await res.json();
                    alert('Error: ' + err.error);
                }
            } catch (err) {
                console.error(err);
                alert('Connection error');
            }
        }

        async function deleteAdmin(id) {
            if (confirm('Are you sure you want to delete this admin account?')) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/users/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        fetchTechData();
                    } else {
                        alert('Failed to delete');
                    }
                } catch (e) { console.error(e); }
            }
        }

        function openAddAdminModal() {
            document.getElementById('addAdminModal').classList.add('active');
        }
        function closeAddAdminModal() {
            document.getElementById('addAdminModal').classList.remove('active');
        }

        fetchTechData();
    </script>
</body>

</html>