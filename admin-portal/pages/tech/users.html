<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/content.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <title>Technician - User Management</title>
</head>

<body>
    <div class="content-header"
        style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
        <div>
            <h1 class="page-title" style="font-size: 2rem; margin-bottom: 0.5rem;">User Management</h1>
            <p class="page-subtitle" style="color: var(--text-secondary);">Manage all registered users in the system</p>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 2.5rem; gap: 1.5rem;">
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                <i data-lucide="users"></i>
            </div>
            <div>
                <div class="stat-value" id="total-users">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <i data-lucide="user-check"></i>
            </div>
            <div>
                <div class="stat-value" id="active-users">0</div>
                <div class="stat-label">Active Users</div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-container"
        style="background: #1e293b; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); overflow: hidden;">
        <table class="data-table">
            <thead>
                <tr style="background: rgba(255,255,255,0.02);">
                    <th style="color: #94a3b8; font-weight: 600; padding: 1.25rem;">User</th>
                    <th style="color: #94a3b8; font-weight: 600;">Contact</th>
                    <th style="color: #94a3b8; font-weight: 600;">Joined</th>
                    <th style="color: #94a3b8; font-weight: 600;">Status</th>
                    <th style="color: #94a3b8; font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- Populated via JS -->
            </tbody>
        </table>
    </div>

    <script>
        lucide.createIcons();
        const API_BASE_URL = (window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:')
            ? 'http://localhost:3000'
            : '';

        async function fetchUsers() {
            try {
                // Fetch Users
                const res = await fetch(`${API_BASE_URL}/api/users`);
                const users = await res.json();

                const tbody = document.getElementById('user-table-body');
                tbody.innerHTML = '';

                document.getElementById('total-users').innerText = users.length;
                const activeCount = users.filter(u => u.status !== 'deactivated').length;
                document.getElementById('active-users').innerText = activeCount;

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No users found.</td></tr>';
                } else {
                    users.forEach(user => {
                        const isDeactivated = user.status === 'deactivated';
                        // Construct Name and Avatar
                        const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username;
                        const initials = ((user.first_name?.[0] || '') + (user.last_name?.[0] || '')).toUpperCase() || 'U';
                        const avatarHtml = user.profile_photo
                            ? `<img src="${user.profile_photo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                            : initials;
                        const avatarStyle = user.profile_photo
                            ? ''
                            : 'background: #e0e7ff; color: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem;';

                        const joinedDate = new Date(user.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <div style="width: 32px; height: 32px; ${avatarStyle}">
                                            ${avatarHtml}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary);">${fullName}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary);">@${user.username}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${user.email || 'No email'}</div>
                                </td>
                                <td><span style="color: var(--text-secondary); font-size: 0.9rem;">${joinedDate}</span></td>
                                <td>
                                    ${isDeactivated
                                ? '<span class="status-badge" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">Deactivated</span>'
                                : '<span class="status-badge status-resolved">Active</span>'}
                                </td>
                                <td>
                                    <div style="display: flex; gap: 0.75rem;">
                                        <button onclick="toggleStatus(${user.id}, '${isDeactivated ? 'active' : 'deactivated'}')"
                                            style="background: ${isDeactivated ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; color: ${isDeactivated ? '#10b981' : '#f59e0b'}; border: 1px solid ${isDeactivated ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}; width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='${isDeactivated ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}'" 
                                            onmouseout="this.style.background='${isDeactivated ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}'"
                                            title="${isDeactivated ? 'Activate Account' : 'Deactivate Account'}">
                                            <i data-lucide="${isDeactivated ? 'power' : 'ban'}" width="14" stroke-width="2.5"></i>
                                        </button>

                                        <button onclick="deleteUser(${user.id})"
                                            style="background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" 
                                            onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'"
                                            title="Delete User">
                                            <i data-lucide="trash-2" width="14" stroke-width="2.5"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                        tbody.appendChild(tr);
                    });
                }
                lucide.createIcons();

            } catch (err) {
                console.error('Error fetching data:', err);
            }
        }

        async function toggleStatus(id, newStatus) {
            if (confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this user?`)) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/users/${id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    if (res.ok) {
                        fetchUsers();
                    } else {
                        alert('Failed to update status');
                    }
                } catch (e) { console.error(e); }
            }
        }

        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/users/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        fetchUsers();
                    } else {
                        alert('Failed to delete');
                    }
                } catch (e) { console.error(e); }
            }
        }

        fetchUsers();
    </script>
</body>

</html>