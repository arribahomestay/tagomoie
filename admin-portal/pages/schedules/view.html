<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/content.css">
    <title>Schedules</title>
    <style>
        .calendar-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .calendar-nav button {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--bg-panel);
            color: var(--text-primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .day-header,
        .day-cell {
            background: var(--bg-card);
            padding: 1rem;
            min-height: 120px;
        }

        .day-header {
            min-height: auto;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 1rem 0;
            font-size: 0.875rem;
            background: var(--bg-panel);
        }

        .day-cell {
            cursor: pointer;
            transition: background 0.2s;
        }

        .day-cell:hover {
            background: var(--bg-panel);
        }

        .day-number {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .day-cell.other-month {
            background: var(--bg-panel);
            color: var(--text-muted);
            pointer-events: none;
        }

        .day-cell.other-month .day-number {
            color: var(--text-muted);
        }

        .event-pill {
            background: #e0e7ff;
            color: #4338ca;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
            border-left: 3px solid #4338ca;
        }

        /* Mobile Schedule View */
        .mobile-schedule-view {
            display: none;
        }

        .mobile-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .mobile-filters::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .schedule-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .schedule-card:active {
            transform: scale(0.98);
            background: var(--bg-panel);
        }

        .date-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-panel);
            border-radius: 8px;
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }

        .date-box .month {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #ef4444;
        }

        .date-box .day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .schedule-info {
            flex: 1;
            min-width: 0;
        }

        .schedule-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .schedule-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            /* Default success/done */
        }

        .status-dot.pending {
            background: #f59e0b;
        }

        .status-dot.upcoming {
            background: #3b82f6;
        }

        @media (max-width: 768px) {
            .calendar-container {
                display: none;
            }

            .mobile-schedule-view {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 1.5rem; gap: 1.5rem;">
        <h1 style="margin: 0;">Schedules & Calendar</h1>
        <button onclick="if(window.parent.openAllSchedulesModal) window.parent.openAllSchedulesModal()"
            style="background: #6366f1; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: background 0.2s;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6" />
                <line x1="8" y1="12" x2="21" y2="12" />
                <line x1="8" y1="18" x2="21" y2="18" />
                <line x1="3" y1="6" x2="3.01" y2="6" />
                <line x1="3" y1="12" x2="3.01" y2="12" />
                <line x1="3" y1="18" x2="3.01" y2="18" />
            </svg>
            Monitor Ongoing
        </button>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <h2 class="calendar-title" id="month-year">December 2023</h2>
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">&larr;</button>
                <button onclick="changeMonth(1)">&rarr;</button>
            </div>
        </div>

        <div class="calendar-grid" id="calendar">
            <!-- Headers -->
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>

            <!-- Days will be injected here -->
        </div>
    </div>

    <!-- Mobile List View -->
    <div class="mobile-schedule-view">
        <div class="mobile-filters">
            <div class="filter-chip active" onclick="filterMobileSchedules('all', this)">All</div>
            <div class="filter-chip" onclick="filterMobileSchedules('upcoming', this)">Upcoming</div>
            <div class="filter-chip" onclick="filterMobileSchedules('today', this)">Today</div>
            <div class="filter-chip" onclick="filterMobileSchedules('past', this)">Past</div>
        </div>

        <div id="mobile-list">
            <!-- List Items Injected Here -->
        </div>
    </div>

    <script>
        let currentDate = new Date();
        const monthYearEl = document.getElementById('month-year');
        const calendarEl = document.getElementById('calendar');

        const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        function loadSchedules() {
            try {
                return JSON.parse(localStorage.getItem('adminSchedules') || '[]');
            } catch (e) {
                return [];
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            monthYearEl.innerText = `${months[month]} ${year}`;

            // Clear days (keep headers)
            const headers = Array.from(calendarEl.querySelectorAll('.day-header'));
            calendarEl.innerHTML = '';
            headers.forEach(h => calendarEl.appendChild(h));

            const firstDayIndex = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();
            const lastDayIndex = new Date(year, month, lastDay).getDay();
            const nextDays = 7 - lastDayIndex - 1;

            const schedules = loadSchedules();

            // Previous Month Days
            const prevLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayIndex; i > 0; i--) {
                const day = document.createElement('div');
                day.classList.add('day-cell', 'other-month');
                day.innerHTML = `<span class="day-number">${prevLastDay - i + 1}</span>`;
                calendarEl.appendChild(day);
            }

            // Current Month Days
            for (let i = 1; i <= lastDay; i++) {
                const day = document.createElement('div');
                day.classList.add('day-cell');

                // Format date string YYYY-MM-DD for comparison
                const monthStr = (month + 1).toString().padStart(2, '0');
                const dayStr = i.toString().padStart(2, '0');
                const dateString = `${year}-${monthStr}-${dayStr}`;

                day.setAttribute('onclick', `openDayModal('${dateString}')`);

                let eventsHtml = '';
                const todaysEvents = schedules.filter(s => s.date === dateString);

                todaysEvents.forEach(ev => {
                    eventsHtml += `<div class="event-pill" title="${ev.id}: ${ev.name}">${ev.id}</div>`;
                });

                day.innerHTML = `<span class="day-number">${i}</span>${eventsHtml}`;
                calendarEl.appendChild(day);
            }

            // Next Month Days
            for (let i = 1; i <= nextDays; i++) {
                const day = document.createElement('div');
                day.classList.add('day-cell', 'other-month');
                day.innerHTML = `<span class="day-number">${i}</span>`;
                calendarEl.appendChild(day);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function openDayModal(dateString) {
            if (window.parent && window.parent.openDayModal) {
                window.parent.openDayModal(dateString);
            } else {
                console.error("Parent modal function 'openDayModal' not found.");
            }
        }

        // Initialize
        renderCalendar();
        renderMobileList();

        window.addEventListener('storage', () => {
            renderCalendar();
            renderMobileList(currentMobileFilter);
        });

        // Mobile List Logic
        let currentMobileFilter = 'all';

        function filterMobileSchedules(filter, btn) {
            currentMobileFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderMobileList(filter);
        }

        function renderMobileList(filter = 'all') {
            const listEl = document.getElementById('mobile-list');
            listEl.innerHTML = '';

            let schedules = loadSchedules();
            // Sort by date desc
            schedules.sort((a, b) => new Date(a.date) - new Date(b.date));

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let filtered = schedules.filter(s => {
                const sDate = new Date(s.date);
                sDate.setHours(0, 0, 0, 0);

                if (filter === 'upcoming') return sDate > today;
                if (filter === 'today') return sDate.getTime() === today.getTime();
                if (filter === 'past') return sDate < today;
                return true;
            });

            if (filtered.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align: center; padding: 3rem 1rem; color: var(--text-secondary);">
                        <i data-lucide="calendar-off" style="width: 48px; height: 48px; opacity: 0.5; margin-bottom: 1rem;"></i>
                        <p>No schedules found for this filter.</p>
                    </div>
                `;
                if (window.lucide) window.lucide.createIcons();
                return;
            }

            filtered.forEach(item => {
                const dateObj = new Date(item.date);
                const month = dateObj.toLocaleString('default', { month: 'short' });
                const day = dateObj.getDate();

                // Determine status logic (simple version)
                let statusClass = 'upcoming';
                let statusText = 'Upcoming';
                const sDate = new Date(item.date);
                sDate.setHours(0, 0, 0, 0);

                if (sDate < today) { statusClass = 'pending'; statusText = 'Past'; } // Or completed
                if (sDate.getTime() === today.getTime()) { statusClass = 'upcoming'; statusText = 'Today'; }

                const card = document.createElement('div');
                card.className = 'schedule-card';
                card.onclick = () => openDayModal(item.date);

                card.innerHTML = `
                    <div class="date-box">
                        <span class="month">${month}</span>
                        <span class="day">${day}</span>
                    </div>
                    <div class="schedule-info">
                        <div class="schedule-title">${item.name}</div>
                        <div class="schedule-meta">
                            <span class="status-dot ${statusClass}"></span>
                            ${statusText} â€¢ ${item.startTime || 'All Day'}
                        </div>
                    </div>
                    <i data-lucide="chevron-right" style="color: var(--text-secondary); width: 20px;"></i>
                `;
                listEl.appendChild(card);
            });

            if (window.lucide) window.lucide.createIcons();
        }
    </script>
</body>

</html>