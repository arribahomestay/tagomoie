<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal | Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/mobile.css">
    <script src="js/mobile-nav.js" defer></script>
    <style>
        /* Appearance Modal Styles */
        .theme-mode-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .theme-mode-option.active {
            border-color: #6366f1 !important;
            background-color: rgba(99, 102, 241, 0.05);
            /* Slight tint for light mode active */
        }

        /* Map Styles */
        #minimap-container {
            height: 150px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-top: 0.5rem;
            cursor: pointer;
        }

        #g-map-full {
            height: 500px;
            width: 100%;
            border-radius: 12px;
        }

        .map-modal-card {
            max-width: 900px;
            width: 95%;
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-card);
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Toggle Button -->
        <div class="toggle-btn" id="sidebar-toggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="2" width="20" height="20" rx="4" stroke="currentColor" stroke-width="2" />
                <path d="M8 10L12 15L16 10H8Z" fill="currentColor" />
            </svg>
        </div>

        <div class="sidebar-header">
            <div class="nav-icon">
                <lottie-player class="logo-lottie" src="assets/animations/SAS.json" background="transparent" speed="1"
                    loop autoplay></lottie-player>
            </div>
            <span class="logo-text">TAGUM <span style="color: #ef4444;">U</span><span
                    style="color: #22c55e;">Y</span>NITE</span>
        </div>

        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-page="dashboard">
                <div class="nav-icon"><i data-lucide="layout-dashboard"></i></div>
                <span class="nav-label">Dashboard</span>
            </a>

            <a href="#" class="nav-item" data-page="issues">
                <div class="nav-icon"><i data-lucide="alert-circle"></i></div>
                <span class="nav-label">Issues</span>
            </a>

            <a href="#" class="nav-item" data-page="users">
                <div class="nav-icon"><i data-lucide="users"></i></div>
                <span class="nav-label">Users</span>
            </a>

            <a href="#" class="nav-item" data-page="messages">
                <div class="nav-icon"><i data-lucide="message-square"></i></div>
                <span class="nav-label">Messages</span>
            </a>
        </nav>

        <!-- Sidebar Footer for Messages Page -->
        <div class="sidebar-footer" id="sidebar-footer"></div>
    </aside>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-navbar" id="mobile-navbar">
        <a href="#" class="mobile-nav-item active" data-page="dashboard">
            <i data-lucide="layout-dashboard"></i>
            <span>Dashboard</span>
        </a>
        <a href="#" class="mobile-nav-item" data-page="issues">
            <i data-lucide="alert-circle"></i>
            <span>Issues</span>
        </a>
        <a href="#" class="mobile-nav-item" data-page="messages">
            <i data-lucide="message-square"></i>
            <span>Messages</span>
        </a>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Messages Header (Dynamic Placement) -->
        <div id="messages-header" style="
            display: none; 
            height: 70px; 
            background: transparent; 
            align-items: center; 
            justify-content: flex-end; 
            padding: 1rem 2rem;
            gap: 1rem;
            flex-shrink: 0;
            position: absolute; 
            top: 0;
            right: 0;
            z-index: 100;
        ">
        </div>

        <!-- Profile Top Nav -->
        <div class="top-nav">
            <!-- Mobile Logo -->
            <div class="mobile-logo" style="display: none;">
                <lottie-player src="assets/animations/SAS.json" background="transparent" speed="1"
                    style="width: 32px; height: 32px;" loop autoplay></lottie-player>
            </div>
            <!-- Notification Bell -->
            <div class="profile-menu-container" style="margin-right: 0;" id="top-nav-wrap-1">
                <div class="notif-btn" id="notif-btn">
                    <lottie-player src="assets/animations/notification.json" background="transparent" speed="1"
                        style="width: 28px; height: 28px;" hover></lottie-player>
                    <div class="notif-badge"></div>
                </div>
                <span class="nav-label footer-label" style="display: none; cursor: pointer;"
                    onclick="event.stopPropagation(); document.getElementById('notif-btn').click();">Notifications</span>
                <!-- Notif Dropdown -->
                <div class="notif-dropdown" id="notif-dropdown">
                    <div class="notif-header">
                        <span>Notifications</span>
                        <span style="font-size: 0.75rem; color: #6366f1; cursor: pointer;">Mark all read</span>
                    </div>
                    <div class="notif-list">
                        <div id="notif-list-container">
                            <!-- Dynamically populated or empty -->
                            <div
                                style="text-align: center; padding: 2rem; color: var(--text-secondary); font-size: 0.85rem;">
                                No new notifications
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-menu-container" id="top-nav-wrap-2">
                <div class="avatar-btn" id="avatar-btn">
                    <i data-lucide="user" width="20" height="20"></i>
                </div>
                <span class="nav-label footer-label" style="display: none; cursor: pointer;"
                    onclick="event.stopPropagation(); document.getElementById('avatar-btn').click();">Profile</span>
                <!-- Dropdown -->
                <div class="dropdown-menu" id="profile-dropdown">
                    <div class="dropdown-item"
                        onclick="openProfileModal(); document.getElementById('profile-dropdown').classList.remove('active');">
                        <i data-lucide="user-cog" width="16"></i> Profile Settings
                    </div>
                    <div class="dropdown-item"
                        onclick="openAppearanceModal(); document.getElementById('profile-dropdown').classList.remove('active');">
                        <i data-lucide="palette" width="16"></i> Appearance
                    </div>
                    <div class="dropdown-item"
                        onclick="openSecurityModal(); document.getElementById('profile-dropdown').classList.remove('active');">
                        <i data-lucide="shield" width="16"></i> Security
                    </div>
                    <div class="dropdown-item logout" id="logout-btn">
                        <i data-lucide="log-out" width="16"></i> Logout
                    </div>
                </div>
            </div>
        </div>

        <div class="page-loader active" id="loader">
            <i data-lucide="loader-2" class="animate-spin" width="32" height="32" color="#6366f1"></i>
        </div>
        <!-- Iframe to load sub-pages content without full reload -->
        <iframe id="content-frame" src=""></iframe>

        <script>
            // Role Based Redirect on Load
            document.addEventListener("DOMContentLoaded", () => {
                const user = JSON.parse(localStorage.getItem('user_token') || '{}');
                const iframe = document.getElementById('content-frame');
                const sidebar = document.getElementById('sidebar');

                // Load Profile Photo if exists
                if (user.profile_photo) {
                    const avatarBtn = document.getElementById('avatar-btn');
                    if (avatarBtn) {
                        avatarBtn.innerHTML = `<img src="${user.profile_photo}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                    }
                }

                if (user.role === 'technician') {
                    // Technician View
                    iframe.src = "pages/tech/view.html";
                    // Modify Sidebar for Technician
                    sidebar.innerHTML = `
                        <div class="sidebar-header">
                            <div class="nav-icon">
                                <i data-lucide="cpu" color="#6366f1"></i>
                            </div>
                            <span class="logo-text">TECH<span style="color: #6366f1;">NICIAN</span></span>
                        </div>
                        <nav class="nav-menu">
                            <a href="#" class="nav-item active" onclick="loadTechPage(this, 'pages/tech/view.html'); return false;">
                                <div class="nav-icon"><i data-lucide="server"></i></div>
                                <span class="nav-label">Admin Management</span>
                            </a>
                            <a href="#" class="nav-item" onclick="loadTechPage(this, 'pages/tech/users.html'); return false;">
                                <div class="nav-icon"><i data-lucide="users"></i></div>
                                <span class="nav-label">User Management</span>
                            </a>
                        </nav>
                        <div class="sidebar-footer"></div>
                    `;
                    lucide.createIcons();

                    // Define page switcher logic
                    window.loadTechPage = function (el, url) {
                        const items = document.querySelectorAll('.nav-item');
                        items.forEach(item => {
                            item.classList.remove('active');
                            item.style.pointerEvents = 'auto';
                        });
                        el.classList.add('active');
                        el.style.pointerEvents = 'none';
                        document.getElementById('content-frame').src = url;
                    };
                } else if (user.role === 'admin') {
                    // Default Admin View
                    iframe.src = "pages/dashboard/view.html";
                } else {
                    // Not logged in or invalid
                    // Optional: window.location.href = '../admin-login/index.html';
                    iframe.src = "pages/dashboard/view.html"; // Fallback for dev
                }
            });
        </script>
    </main>

    <!-- Global Details Modal -->
    <div class="modal-overlay" id="globalModal">
        <div class="modal-card" style="max-width: 650px; border-radius: 16px; overflow: hidden;">
            <div class="modal-header"
                style="background: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 1.25rem 1.5rem;">
                <h2 class="modal-title" style="font-size: 1.25rem; font-weight: 700;">Issue Details</h2>
                <button class="modal-close" onclick="closeGlobalModal()" style="font-size: 1.5rem;">&times;</button>
            </div>

            <div class="modal-body"
                style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; max-height: 70vh; overflow-y: auto; background: var(--bg-panel);">
                <!-- Header Info Box -->
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; background: var(--bg-card); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color);">
                    <div>
                        <span class="label" style="font-size: 0.75rem; opacity: 0.7;">ISSUE ID</span>
                        <div class="value" id="g-id" style="font-weight: 700; color: var(--text-primary);">#0000</div>
                    </div>
                    <div>
                        <span class="label" style="font-size: 0.75rem; opacity: 0.7;">REPORTED BY</span>
                        <div class="value" id="g-reporter" style="font-weight: 600;">Reporter</div>
                    </div>
                </div>

                <div>
                    <span class="label">Issue Name</span>
                    <div class="value" id="g-name"
                        style="font-size: 1.25rem; font-weight: 700; color: #6366f1; margin-top: 0.25rem;">Issue Name
                    </div>
                </div>

                <!-- Location & Address Section -->
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.25rem;">
                    <div>
                        <span class="label">Report Address</span>
                        <div id="g-full-address"
                            style="line-height: 1.5; color: var(--text-primary); background: var(--bg-card); padding: 0.85rem; border-radius: 10px; border: 1px solid var(--border-color); margin-top: 0.25rem; font-size: 0.9rem;">
                            <div id="g-brgy" style="font-weight: 600;">Barangay Name</div>
                            <div id="g-street">Street / Purok</div>
                            <div id="g-landmarks"
                                style="font-size: 0.8rem; color: var(--text-secondary); font-style: italic;">
                                Landmarks...</div>
                        </div>
                    </div>
                    <div>
                        <span class="label">Location Pin</span>
                        <div id="minimap-container" onclick="openMapModal()">
                            <div id="g-minimap" style="height: 100%; width: 100%; pointer-events: none;"></div>
                        </div>
                        <div
                            style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 0.25rem;">
                            Click to enlarge map</div>
                    </div>
                </div>

                <!-- Dual Column Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                    <div
                        style="background: var(--bg-card); padding: 0.85rem; border-radius: 10px; border: 1px solid var(--border-color);">
                        <span class="label" style="font-size: 0.75rem;">PRIORITY</span>
                        <div id="g-priority" style="text-transform: capitalize; font-weight: 700; margin-top: 0.25rem;">
                            Low</div>
                    </div>
                    <div
                        style="background: var(--bg-card); padding: 0.85rem; border-radius: 10px; border: 1px solid var(--border-color);">
                        <span class="label" style="font-size: 0.75rem;">POST STATUS</span>
                        <div id="g-post-status"
                            style="text-transform: capitalize; font-weight: 700; margin-top: 0.25rem;">Pending</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                    <div>
                        <span class="label">Processing Status</span>
                        <div class="value" id="g-status" style="font-weight: 600; margin-top: 0.25rem;">Status</div>
                    </div>
                    <div>
                        <span class="label">Date Submitted</span>
                        <div class="value" id="g-date" style="margin-top: 0.25rem;">Date</div>
                    </div>
                </div>

                <div>
                    <span class="label">Description</span>
                    <div class="value" id="g-desc"
                        style="line-height: 1.6; color: var(--text-secondary); background: var(--bg-card); padding: 1rem; border-radius: 10px; border: 1px solid var(--border-color); margin-top: 0.5rem;">
                        Description text...
                    </div>
                </div>

                <div>
                    <span class="label">Attachments</span>
                    <div class="modal-media-gallery" id="g-media"
                        style="margin-top: 0.75rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.75rem;">
                        <!-- Media items -->
                    </div>
                </div>

                <div>
                    <span class="label">Reactions</span>
                    <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
                        <div onclick="toggleReaction('like')"
                            style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; background: rgba(16, 185, 129, 0.1); padding: 0.5rem 1rem; border-radius: 8px; color: #10b981; font-weight: 600; transition: transform 0.2s;"
                            onmouseover="this.style.transform='scale(1.05)'"
                            onmouseout="this.style.transform='scale(1)'">
                            <i data-lucide="thumbs-up" width="18"></i>
                            <span id="g-likes">0</span> Likes
                        </div>
                        <div onclick="toggleReaction('dislike')"
                            style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; background: rgba(239, 68, 68, 0.1); padding: 0.5rem 1rem; border-radius: 8px; color: #ef4444; font-weight: 600; transition: transform 0.2s;"
                            onmouseover="this.style.transform='scale(1.05)'"
                            onmouseout="this.style.transform='scale(1)'">
                            <i data-lucide="thumbs-down" width="18"></i>
                            <span id="g-dislikes">0</span> Dislikes
                        </div>
                    </div>
                </div>

                <!-- Admin Moderation Panel -->
                <div id="admin-moderation-card"
                    style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05)); padding: 1.25rem; border-radius: 14px; border: 1px solid rgba(99, 102, 241, 0.2); display: none; margin-top: 0.5rem;">
                    <span class="label"
                        style="display: block; margin-bottom: 0.75rem; color: #6366f1; font-weight: 700;">Wait for
                        Review</span>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn-action btn-approve" onclick="moderateIssue('approved')"
                            style="flex:1; background: #10b981; color: white; padding: 0.85rem; border-radius: 10px; border:none; cursor:pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: transform 0.2s;">
                            Approve Post
                        </button>
                        <button class="btn-action btn-decline" onclick="moderateIssue('rejected')"
                            style="flex:1; background: #fee2e2; color: #ef4444; padding: 0.85rem; border-radius: 10px; border:none; cursor:pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: transform 0.2s;">
                            Decline Post
                        </button>
                    </div>
                </div>

                <!-- Comment Section -->
                <div style="margin-top: 1rem; padding-top: 1.25rem; border-top: 1px solid var(--border-color);">
                    <span class="label" style="font-weight: 700;">Communication Log</span>
                    <div id="g-comments-list"
                        style="max-height: 180px; overflow-y: auto; margin-top: 1rem; display:flex; flex-direction:column; gap:0.75rem; scroll-behavior: smooth;">
                        <!-- Comments -->
                    </div>
                    <div
                        style="display: flex; gap: 0.5rem; background: var(--bg-card); padding: 0.5rem; border-radius: 12px; border: 1px solid var(--border-color); margin-top: 1rem;">
                        <input type="text" id="g-comment-input" placeholder="Type a message to the reporter..."
                            onkeyup="if(event.key === 'Enter') postComment()"
                            style="flex: 1; padding: 0.6rem 0.75rem; border: none; background: transparent; color: var(--text-primary); outline: none; font-size: 0.95rem;">
                        <button class="btn-primary" onclick="postComment()"
                            style="padding: 0.6rem 1.5rem; font-size: 0.95rem; border-radius: 10px; transition: all 0.2s;">Send</button>
                    </div>
                </div>
            </div>

            <!-- Modal Footer with Grouped Actions -->
            <div class="modal-footer"
                style="padding: 1.25rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 1rem; background: var(--bg-card);">

                <!-- Respond Logic Row -->
                <div id="respond-section"
                    style="display: flex; gap: 0.5rem; align-items: center; width: 100%; display: none;">
                    <div style="display: flex; gap: 0.5rem; flex: 1;">
                        <input type="date" id="response-date"
                            style="flex:1; padding: 0.75rem; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-panel); color: var(--text-primary);">
                        <input type="time" id="response-time"
                            style="flex:1; padding: 0.75rem; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-panel); color: var(--text-primary);">
                    </div>
                    <button class="btn-action btn-respond" onclick="handleRespond()"
                        style="background: #6366f1; color: white; padding: 0.75rem 1.5rem; border-radius: 10px; border:none; cursor:pointer; font-weight: 700;">
                        Assign/Respond
                    </button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <button class="btn-action btn-delete" onclick="deleteIssue()"
                        style="background: rgba(239, 68, 68, 0.05); color: #ef4444; padding: 0.75rem 1.25rem; border-radius: 10px; border: 1px solid rgba(239, 68, 68, 0.1); cursor:pointer; font-weight: 600;">
                        Delete Report
                    </button>

                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn-action btn-complete" id="btn-mark-completed"
                            onclick="updateIssueStatus('Resolved')"
                            style="background: #10b981; color: white; padding: 0.75rem 1.5rem; border-radius: 10px; border:none; cursor:pointer; font-weight: 700; display: none;">
                            Mark Completed
                        </button>
                        <button class="btn-action" onclick="closeGlobalModal()"
                            style="background: var(--bg-panel); color: var(--text-secondary); padding: 0.75rem 1.5rem; border-radius: 10px; border: 1px solid var(--border-color); cursor:pointer; font-weight: 600;">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div class="modal-overlay" id="profileModal" style="z-index: 2000;">
        <div class="modal-card" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="modal-close" onclick="closeProfileModal()">&times;</button>
            </div>

            <div id="profile-form-container" style="display: flex; flex-direction: column; gap: 1.25rem;">
                <!-- Photo Upload -->
                <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 0.5rem;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: #e0e7ff; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; border: 2px solid #6366f1;"
                        onclick="document.getElementById('profile-upload').click()" id="avatar-btn">
                        <i data-lucide="user" id="default-avatar-icon"
                            style="width: 40px; height: 40px; color: #6366f1;"></i>
                        <img id="preview-avatar" src="" alt="Avatar"
                            style="width: 100%; height: 100%; object-fit: cover; display: none;">
                    </div>
                    <input type="file" id="profile-upload" accept="image/*" style="display: none;"
                        onchange="handleImageUpload(event)">
                    <span style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">Click to change photo</span>
                </div>

                <!-- Name -->
                <div>
                    <label
                        style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.5rem;">Full
                        Name</label>
                    <input type="text" id="p-name" value="Admin User"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.95rem; color: #1e293b;">
                </div>

                <!-- Username -->
                <div>
                    <label
                        style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.5rem;">Username</label>
                    <input type="text" id="p-username" value="admin123"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.95rem; color: #1e293b;">
                </div>

                <!-- Email -->
                <div>
                    <label
                        style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.5rem;">Email</label>
                    <input type="email" id="p-email" placeholder="user@example.com"
                        style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.95rem; color: #1e293b;">
                </div>

                <!-- Department (Read-only) -->
                <div>
                    <label
                        style="display: block; font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.5rem;">Department</label>
                    <input type="text" id="p-department" value="Not Assigned" readonly
                        style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.95rem; color: #64748b; background: #f8fafc; cursor: not-allowed;">
                    <span style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; display: block;">Contact an
                        administrator to change your department</span>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1rem;">
                    <button type="button" onclick="closeProfileModal()"
                        style="padding: 0.75rem 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0; background: white; color: #64748b; cursor: pointer; font-weight: 500;">Cancel</button>
                    <button type="button" onclick="saveProfile(event)"
                        style="padding: 0.75rem 1.5rem; border-radius: 8px; border: none; background: #6366f1; color: white; cursor: pointer; font-weight: 500;">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Details Modal (Global) -->
    <div class="day-modal-overlay" id="dayModal">
        <div class="day-modal">
            <div class="day-modal-header">
                <h3 class="day-modal-title" id="selectedDateTitle">Date</h3>
                <button class="day-modal-close" onclick="closeDayModal()">&times;</button>
            </div>

            <div class="filter-controls">
                <button class="time-filter-btn active" onclick="filterTime('All', this)">All Day</button>
                <button class="time-filter-btn" onclick="filterTime('Morning', this)">Morning</button>
                <button class="time-filter-btn" onclick="filterTime('Afternoon', this)">Afternoon</button>
            </div>

            <div class="day-events-list" id="dayEventsList">
                <!-- Events populated by JS -->
            </div>
        </div>
    </div>

    <!-- Security Modal -->
    <div class="modal-overlay" id="securityModal" style="z-index: 2100;">
        <div class="modal-card"
            style="max-width: 700px; padding: 0; display: flex; flex-direction: column; height: 500px;">
            <div class="modal-header" style="padding: 1.5rem; margin-bottom: 0;">
                <h2 class="modal-title">Security Settings</h2>
                <button class="modal-close" onclick="closeSecurityModal()">&times;</button>
            </div>
            <div class="sec-body">
                <div class="sec-sidebar">
                    <div class="sec-nav-item active" onclick="switchSecTab('password', this)">
                        <i data-lucide="key" width="16"
                            style="display: inline-block; vertical-align: middle; margin-right: 8px;"></i> Password
                    </div>
                    <div class="sec-nav-item" onclick="switchSecTab('email', this)">
                        <i data-lucide="mail" width="16"
                            style="display: inline-block; vertical-align: middle; margin-right: 8px;"></i> Email
                    </div>
                    <div class="sec-nav-item" onclick="switchSecTab('2fa', this)">
                        <i data-lucide="shield-check" width="16"
                            style="display: inline-block; vertical-align: middle; margin-right: 8px;"></i> 2FA
                    </div>
                    <div class="sec-nav-item" onclick="switchSecTab('alerts', this)">
                        <i data-lucide="bell" width="16"
                            style="display: inline-block; vertical-align: middle; margin-right: 8px;"></i> Login Alerts
                    </div>
                </div>
                <div class="sec-content">
                    <!-- Password Tab -->
                    <div id="sec-view-password" class="sec-view active">
                        <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 1.5rem;">Change Password</h3>
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" id="sec-current-password" class="form-input"
                                placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" id="sec-new-password" class="form-input"
                                placeholder="Enter new password">
                            <span
                                style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; display: block;">Minimum
                                8 characters</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" id="sec-confirm-password" class="form-input"
                                placeholder="Confirm new password">
                        </div>
                        <div style="text-align: right; margin-top: 2rem;">
                            <button class="btn-primary" onclick="updatePassword()">Update
                                Password</button>
                        </div>
                    </div>

                    <!-- Email Tab -->
                    <div id="sec-view-email" class="sec-view">
                        <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 1.5rem;">Update Email Address</h3>
                        <div class="form-group">
                            <label class="form-label">Current Email</label>
                            <input type="email" id="sec-current-email" class="form-input" value="Loading..." readonly
                                style="background: #f8fafc; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Email Address</label>
                            <input type="email" id="sec-new-email" class="form-input"
                                placeholder="Enter new email address">
                        </div>
                        <div style="text-align: right; margin-top: 2rem;">
                            <button class="btn-primary" onclick="updateEmail()">Update
                                Email</button>
                        </div>
                    </div>

                    <!-- 2FA Tab -->
                    <div id="sec-view-2fa" class="sec-view">
                        <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 1.5rem;">Two-Factor Authentication
                        </h3>
                        <div
                            style="background: var(--bg-panel); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 1.5rem;">
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                                        Authenticator App</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Use an app like
                                        Google Authenticator</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="chk-2fa-app">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">
                                        SMS Authentication</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Receive codes via SMS
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="chk-2fa-sms">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 2rem;">
                            <button class="btn-primary" onclick="searchSecSave('2FA settings updated!')">Save
                                Settings</button>
                        </div>
                    </div>

                    <!-- Login Alerts Tab -->
                    <div id="sec-view-alerts" class="sec-view">
                        <h3 style="font-size: 1.1rem; color: #1e293b; margin-bottom: 1.5rem;">Recent Login Activity</h3>
                        <div class="table-responsive"
                            style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: var(--bg-panel);">
                                    <tr>
                                        <th
                                            style="text-align: left; padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem;">
                                            Device</th>
                                        <th
                                            style="text-align: left; padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem;">
                                            Location</th>
                                        <th
                                            style="text-align: left; padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem;">
                                            Date & Time</th>
                                        <th
                                            style="text-align: right; padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem;">
                                            Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Current Session -->
                                    <tr style="background: rgba(16, 185, 129, 0.05);">
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i data-lucide="monitor" width="16" style="color: #6366f1;"></i>
                                                <span style="font-weight: 500; color: var(--text-primary);">Windows PC
                                                    (Current)</span>
                                            </div>
                                        </td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                            Davao City, PH</td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); color: #10b981; font-weight: 500;">
                                            Active Now</td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: right;">
                                            <span style="font-size: 0.8rem; color: #94a3b8;">Current</span>
                                        </td>
                                    </tr>
                                    <!-- Past Sessions -->
                                    <tr id="device-row-1">
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i data-lucide="smartphone" width="16"
                                                    style="color: var(--text-secondary);"></i>
                                                <span style="color: var(--text-primary);">iPhone 13</span>
                                            </div>
                                        </td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                            Tagum City, PH</td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                            Oct 24, 10:30 AM</td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: right;">
                                            <button onclick="logoutDevice('device-row-1')"
                                                style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                                                onmouseover="this.style.background='#ef4444'; this.style.color='white'"
                                                onmouseout="this.style.background='transparent'; this.style.color='#ef4444'">
                                                Log Out
                                            </button>
                                        </td>
                                    </tr>
                                    <tr id="device-row-2">
                                        <td style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <i data-lucide="monitor" width="16"
                                                    style="color: var(--text-secondary);"></i>
                                                <span style="color: var(--text-primary);">MacBook Pro</span>
                                            </div>
                                        </td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                            Cebu City, PH</td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary);">
                                            Oct 20, 08:15 PM</td>
                                        <td
                                            style="padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: right;">
                                            <button onclick="logoutDevice('device-row-2')"
                                                style="background: transparent; border: 1px solid #ef4444; color: #ef4444; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;"
                                                onmouseover="this.style.background='#ef4444'; this.style.color='white'"
                                                onmouseout="this.style.background='transparent'; this.style.color='#ef4444'">
                                                Log Out
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div
                            style="margin-top: 1.5rem; display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border: 1px solid rgba(245, 158, 11, 0.2);">
                            <i data-lucide="alert-triangle" width="18" style="color: #f59e0b;"></i>
                            <span style="font-size: 0.9rem; color: #b45309;">Don't recognize a device? <a href="#"
                                    onclick="logoutAllDevices()"
                                    style="color: #b45309; font-weight: 600; text-decoration: underline;">Log out all
                                    other sessions</a></span>
                        </div>
                        <script>

                            function logoutDevice(rowId) {
                                if (confirm('Are you sure you want to log out this device?')) {
                                    const row = document.getElementById(rowId);
                                    if (row) {
                                        row.style.opacity = '0.5';
                                        row.style.pointerEvents = 'none';
                                        setTimeout(() => {
                                            row.remove();
                                            alert('Device logged out successfully.');
                                        }, 500);
                                    }
                                }
                            }

                            function logoutAllDevices() {
                                if (confirm('Are you sure you want to log out of ALL other sessions? This action cannot be undone.')) {
                                    const row1 = document.getElementById('device-row-1');
                                    const row2 = document.getElementById('device-row-2');
                                    if (row1) row1.remove();
                                    if (row2) row2.remove();
                                    alert('All other sessions have been logged out.');
                                }
                            }
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Modal -->
    <div class="modal-overlay" id="appearanceModal" style="z-index: 2200;">
        <div class="modal-card" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Appearance Settings</h2>
                <button class="modal-close" onclick="closeAppearanceModal()">&times;</button>
            </div>

            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1rem; color: #1e293b; margin-bottom: 1rem;">Interface Theme</h3>
                <div style="display: flex; gap: 1rem;">
                    <div class="theme-mode-option active" id="mode-light" onclick="setThemeMode('light')"
                        style="padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; width: 100%; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                        <i data-lucide="sun" width="24" style="color: var(--text-secondary);"></i>
                        <span style="font-weight: 500; color: var(--text-primary);">Light Mode</span>
                    </div>

                    <div class="theme-mode-option" id="mode-dark" onclick="setThemeMode('dark')"
                        style="padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 12px; width: 100%; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; background: #0f172a;">
                        <i data-lucide="moon" width="24" style="color: #94a3b8;"></i>
                        <span style="font-weight: 500; color: #f8fafc;">Dark Mode</span>
                    </div>
                </div>
            </div>

            <div style="text-align: right;">
                <button class="btn-primary" onclick="saveAppearance()">Apply Changes</button>
            </div>
        </div>
    </div>

    <!-- Critical Issues Modal -->
    <div class="modal-overlay" id="criticalIssuesModal" style="z-index: 2300;">
        <div class="modal-card" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" style="color: #ef4444; display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="alert-octagon" width="24"></i>
                    All Critical Issues
                </h2>
                <button class="modal-close" onclick="closeCriticalIssuesModal()">&times;</button>
            </div>

            <div class="modal-body" style="max-height: 500px; overflow-y: auto; padding-right: 0.5rem;">
                <div id="critical-list-container">
                    <!-- Dynamically populated or empty -->
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No critical issues at the moment.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div class="lightbox-overlay" id="lightboxModal" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-img" id="lightboxImage" src="" alt="Preview">
    </div>

    <script>
        // Lightbox Logic
        const lightboxModal = document.getElementById('lightboxModal');
        const lightboxImage = document.getElementById('lightboxImage');

        window.openLightbox = function (src) {
            lightboxImage.src = src;
            lightboxModal.classList.add('active');
        }

        window.closeLightbox = function () {
            lightboxModal.classList.remove('active');
            setTimeout(() => {
                lightboxImage.src = '';
            }, 300); // Clear after fade out
        }

        // Critical Issues Modal Logic
        const criticalIssuesModal = document.getElementById('criticalIssuesModal');

        window.openCriticalIssuesModal = function () {
            criticalIssuesModal.classList.add('active');
            lucide.createIcons();
        }

        window.closeCriticalIssuesModal = function () {
            criticalIssuesModal.classList.remove('active');
        }

        criticalIssuesModal.addEventListener('click', (e) => {
            if (e.target === criticalIssuesModal) closeCriticalIssuesModal();
        });
    </script>

    <!-- Map Modal -->
    <div class="modal-overlay" id="mapModal" style="z-index: 3000;">
        <div class="map-modal-card">
            <div class="modal-header"
                style="background: var(--bg-card); border-bottom: 1px solid var(--border-color); padding: 1.25rem 1.5rem;">
                <h2 class="modal-title"
                    style="font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="map-pin" style="color: #ef4444;"></i>
                    Location Map
                </h2>
                <button class="modal-close" onclick="closeMapModal()" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1rem; background: var(--bg-panel);">
                <div id="g-map-full"></div>
                <div style="margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div id="g-map-coords"
                        style="font-family: monospace; font-size: 0.85rem; color: var(--text-secondary);">
                        Lat: 0, Lng: 0
                    </div>
                    <button class="btn-primary" onclick="closeMapModal()">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Widget -->
    <!-- Chat Widget Removed -->

    <script>
        // Initialize Lucide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            console.warn('Lucide icons library not loaded.');
        }

        const API_BASE_URL = (window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:')
            ? 'http://localhost:3000'
            : '';

        // --- NOTIFICATION DROPDOWN LOGIC ---
        const notifBtn = document.getElementById('notif-btn');
        const notifDropdown = document.getElementById('notif-dropdown');

        if (notifBtn) {
            notifBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close profile if open
                if (profileDropdown.classList.contains('active')) profileDropdown.classList.remove('active');

                notifDropdown.classList.toggle('active');
                notifBtn.classList.toggle('active');
            });
        }

        // Profile Dropdown Logic
        const avatarBtn = document.getElementById('avatar-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const logoutBtn = document.getElementById('logout-btn');

        avatarBtn.addEventListener('click', (e) => {
            profileDropdown.classList.toggle('active');
        });

        // Sidebar Navigation Logic for Full Page Apps
        const navLinks = document.querySelectorAll('.nav-item');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // Update Active State
                navLinks.forEach(n => n.classList.remove('active'));
                link.classList.add('active');

                // Load Page
                const page = link.getAttribute('data-page');
                const contentFrame = document.getElementById('content-frame');
                contentFrame.src = `pages/${page}/view.html`;

                // Handle Full Screen Pages (Messages)
                const mainContent = document.querySelector('.main-content');
                if (page === 'messages') {
                    mainContent.classList.add('no-padding');
                    moveNavIcons('header'); // Move to messages header
                } else {
                    mainContent.classList.remove('no-padding');
                    moveNavIcons('top-nav'); // Move back to top nav
                }
            });
        });

        // Dynamic Nav Icon Mover
        const topNav = document.querySelector('.top-nav');
        const sidebarFooter = document.getElementById('sidebar-footer');
        const messagesHeader = document.getElementById('messages-header'); // New target

        function moveNavIcons(destination) {
            const wrap1 = document.getElementById('top-nav-wrap-1'); // Notifications
            const wrap2 = document.getElementById('top-nav-wrap-2'); // Profile

            // Reset classes
            wrap1.classList.remove('in-sidebar', 'in-header');
            wrap2.classList.remove('in-sidebar', 'in-header');

            if (destination === 'sidebar') {
                wrap1.classList.add('in-sidebar');
                wrap2.classList.add('in-sidebar');
                sidebarFooter.appendChild(wrap1);
                sidebarFooter.appendChild(wrap2);
                topNav.style.pointerEvents = 'none';
                messagesHeader.style.display = 'none';
            } else if (destination === 'header') {
                wrap1.classList.add('in-header'); // We might need styling for this
                wrap2.classList.add('in-header');
                messagesHeader.appendChild(wrap1);
                messagesHeader.appendChild(wrap2);
                messagesHeader.style.display = 'flex';
                topNav.style.pointerEvents = 'none';
            } else {
                // Back to Top Nav
                topNav.appendChild(wrap1);
                topNav.appendChild(wrap2);
                topNav.style.pointerEvents = 'auto';
                messagesHeader.style.display = 'none';
            }
        }

        // Open Profile Settings from Dropdown
        document.querySelector('.dropdown-item:first-child').addEventListener('click', () => {
            openProfileModal();
            profileDropdown.classList.remove('active');
        });

        document.addEventListener('click', (e) => {
            // Close Profile
            if (!profileDropdown.contains(e.target) && !avatarBtn.contains(e.target)) {
                profileDropdown.classList.remove('active');
            }
            // Close Notifications
            if (notifBtn && !notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
                notifDropdown.classList.remove('active');
                notifBtn.classList.remove('active');
            }
        });


        // Profile Modal Logic
        const profileModal = document.getElementById('profileModal');

        function openProfileModal() {
            const savedProfile = JSON.parse(localStorage.getItem('adminProfile') || '{}');
            if (savedProfile.name) document.getElementById('p-name').value = savedProfile.name;
            if (savedProfile.username) document.getElementById('p-username').value = savedProfile.username;
            if (savedProfile.email) document.getElementById('p-email').value = savedProfile.email;
            if (savedProfile.avatar) {
                document.getElementById('preview-avatar').src = savedProfile.avatar;
                document.getElementById('preview-avatar').style.display = 'block';
                document.getElementById('default-avatar-icon').style.display = 'none';
            }
            profileModal.classList.add('active');
        }

        function closeProfileModal() {
            profileModal.classList.remove('active');
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview-avatar').src = e.target.result;
                    document.getElementById('preview-avatar').style.display = 'block';
                    document.getElementById('default-avatar-icon').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        function saveProfile(e) {
            e.preventDefault();
            const name = document.getElementById('p-name').value;
            const username = document.getElementById('p-username').value;
            const email = document.getElementById('p-email').value;
            const avatarSrc = document.getElementById('preview-avatar').src;

            const profile = { name, username, email, avatar: avatarSrc !== window.location.href ? avatarSrc : null };
            localStorage.setItem('adminProfile', JSON.stringify(profile));

            alert('Profile saved successfully!');
            closeProfileModal();
        }

        // Global Modal Logic
        const globalModal = document.getElementById('globalModal');
        let currentIssueId = null;
        let currentIssueName = null;
        let currentLat = null;
        let currentLng = null;
        let miniMap = null;
        let fullMap = null;
        let miniMarker = null;
        let fullMarker = null;

        // Mock Attachments Data
        const mockAttachments = {
            '#1024': [
                { type: 'image', src: 'https://placehold.co/600x400/png?text=Karaoke+Proof+1' },
                { type: 'video', src: 'https://www.w3schools.com/html/mov_bbb.mp4' }
            ],
            '#1025': [
                { type: 'image', src: 'https://placehold.co/600x400/png?text=Broken+Road' },
                { type: 'image', src: 'https://placehold.co/600x400/png?text=Accident+Scene' }
            ],
            '#1027': [
                { type: 'image', src: 'https://placehold.co/600x400/png?text=Dark+Street' }
            ]
        };

        window.openGlobalModal = function (data) {
            const { id, name, reporter, date, status, desc, images, priority, postStatus, barangay, street, landmarks, lat, lng } = data;
            currentIssueId = id;
            currentIssueName = name;
            currentLat = lat || 7.4477; // Default Tagum
            currentLng = lng || 125.8447;

            document.getElementById('g-id').innerText = id;
            document.getElementById('g-name').innerText = name;
            document.getElementById('g-reporter').innerText = reporter;
            document.getElementById('g-date').innerText = date;

            // Address Fields
            document.getElementById('g-brgy').innerText = barangay || 'Unknown Barangay';
            document.getElementById('g-street').innerText = street || 'No Street Provided';
            document.getElementById('g-landmarks').innerText = landmarks ? `Landmarks: ${landmarks}` : 'No Landmarks';

            // Priority and Post Status
            const priorityEl = document.getElementById('g-priority');
            const postStatusEl = document.getElementById('g-post-status');
            priorityEl.innerText = priority || 'Low';

            // Normalize for display and logic
            const normalizedPostStatus = (postStatus || 'pending').toLowerCase().trim();
            postStatusEl.innerText = normalizedPostStatus;

            // Priority Color
            const prioLower = (priority || '').toLowerCase();
            if (prioLower === 'high' || prioLower === 'critical') priorityEl.style.color = '#ef4444';
            else if (prioLower === 'medium') priorityEl.style.color = '#f59e0b';
            else priorityEl.style.color = '#10b981';

            // Post Status Color
            if (normalizedPostStatus === 'approved') postStatusEl.style.color = '#10b981';
            else if (normalizedPostStatus === 'rejected') postStatusEl.style.color = '#ef4444';
            else postStatusEl.style.color = '#f59e0b';

            const statusEl = document.getElementById('g-status');
            statusEl.innerText = status;
            statusEl.className = 'value'; // Reset

            applyStatusColor(statusEl, status);
            document.getElementById('g-desc').innerText = desc;

            // Render Media
            const mediaContainer = document.getElementById('g-media');
            if (mediaContainer) {
                mediaContainer.innerHTML = '';
                const mediaList = (images && Array.isArray(images)) ? images : [];

                if (mediaList.length > 0) {
                    mediaList.forEach(media => {
                        const item = document.createElement('div');
                        item.className = 'media-item';
                        let src = media.url || media.src || media;
                        let type = media.type || 'image';

                        if (typeof src === 'string' && src.match(/\.(mp4|webm|ogg)$/i)) {
                            type = 'video';
                        }

                        if (type === 'image' || type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'Attachment';
                            img.onclick = () => window.openLightbox(src);
                            item.appendChild(img);
                        } else {
                            const vid = document.createElement('video');
                            vid.src = src;
                            vid.controls = true;
                            item.appendChild(vid);
                        }
                        mediaContainer.appendChild(item);
                    });
                } else {
                    mediaContainer.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.9rem;">No media attached.</span>';
                }
            }

            // Reset Reactions
            document.getElementById('g-likes').innerText = '0';
            document.getElementById('g-dislikes').innerText = '0';
            fetchReactions(id);

            // Fetch Comments
            fetchComments(id);

            document.getElementById('response-date').valueAsDate = new Date();
            document.getElementById('response-time').value = '08:00'; // Default
            updateModalButtons(status, postStatus);
            globalModal.classList.add('active');

            // Initialize icons in modal
            if (typeof lucide !== 'undefined') lucide.createIcons();

            // Set Mapbox Token
            mapboxgl.accessToken = 'pk.eyJ1IjoiZWpzZWd1aWRvIiwiYSI6ImNtaDdkOGJqODAyMzMya3Exb2ZyYWlmcXUifQ.UDeG5YHwJOAhFpc_tpDAuQ';

            // Initialize Minimap
            setTimeout(() => {
                if (!miniMap) {
                    miniMap = new mapboxgl.Map({
                        container: 'g-minimap',
                        style: 'mapbox://styles/mapbox/light-v11',
                        center: [currentLng, currentLat],
                        zoom: 14,
                        interactive: false,
                        attributionControl: false
                    });
                    miniMarker = new mapboxgl.Marker({ color: '#ef4444' }).setLngLat([currentLng, currentLat]).addTo(miniMap);
                } else {
                    miniMap.setCenter([currentLng, currentLat]);
                    miniMarker.setLngLat([currentLng, currentLat]);
                    miniMap.resize();
                }
            }, 300);
        }

        const mapModal = document.getElementById('mapModal');
        window.openMapModal = function () {
            mapModal.classList.add('active');
            document.getElementById('g-map-coords').innerText = `Lat: ${currentLat.toFixed(6)}, Lng: ${currentLng.toFixed(6)}`;

            setTimeout(() => {
                if (!fullMap) {
                    fullMap = new mapboxgl.Map({
                        container: 'g-map-full',
                        style: 'mapbox://styles/mapbox/light-v11', // Light mode for better visibility
                        center: [currentLng, currentLat],
                        zoom: 16.5,
                        pitch: 60,
                        bearing: -20,
                        antialias: true
                    });

                    fullMap.on('load', () => {
                        // 3D Buildings
                        const layers = fullMap.getStyle().layers;
                        const labelLayerId = layers.find(
                            (layer) => layer.type === 'symbol' && layer.layout['text-field']
                        ).id;

                        fullMap.addLayer(
                            {
                                'id': 'add-3d-buildings',
                                'source': 'composite',
                                'source-layer': 'building',
                                'filter': ['==', 'extrude', 'true'],
                                'type': 'fill-extrusion',
                                'minzoom': 15,
                                'paint': {
                                    'fill-extrusion-color': '#94a3b8',
                                    'fill-extrusion-height': ['get', 'height'],
                                    'fill-extrusion-base': ['get', 'min_height'],
                                    'fill-extrusion-opacity': 0.5
                                }
                            },
                            labelLayerId
                        );
                    });

                    fullMarker = new mapboxgl.Marker({ color: '#ef4444' })
                        .setLngLat([currentLng, currentLat])
                        .addTo(fullMap);

                    fullMap.addControl(new mapboxgl.NavigationControl(), 'top-right');
                } else {
                    fullMap.setCenter([currentLng, currentLat]);
                    fullMarker.setLngLat([currentLng, currentLat]);
                    fullMap.resize();
                }
            }, 300);
        }

        window.closeMapModal = function () {
            mapModal.classList.remove('active');
        }

        mapModal.addEventListener('click', (e) => {
            if (e.target === mapModal) closeMapModal();
        });

        window.toggleReaction = async function (type) {
            console.log('toggleReaction called with type:', type);

            let userId = 1; // Default
            try {
                const user = JSON.parse(localStorage.getItem('user_token'));
                if (user && user.id) userId = user.id;
            } catch (e) { }
            console.log('Using userId:', userId);

            // Use the ID as is (encoded for URL safety)
            const rawId = currentIssueId;
            console.log('Report ID:', rawId);

            if (!rawId) {
                console.error('Error: No report ID found');
                return;
            }

            try {
                // Encode the ID to handle '#' correctly in URL
                const url = `${API_BASE_URL}/api/reports/${encodeURIComponent(rawId)}/reactions`;
                console.log('Sending POST to:', url);

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userId, reactionType: type })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    console.error('Reaction update failed:', err);
                    throw new Error(err.error || `Server Error ${res.status}`);
                }

                console.log('Reaction updated successfully');
                fetchReactions(rawId);
            } catch (err) {
                console.error('Reaction error:', err);
                alert('Reaction Failed: ' + err.message);
            }
        }

        async function fetchReactions(reportId) {
            // Encode the ID to handle '#' correctly
            try {
                const res = await fetch(`${API_BASE_URL}/api/reports/${encodeURIComponent(reportId)}/reactions`);
                if (!res.ok) throw new Error('Failed to fetch reactions');

                const data = await res.json();
                document.getElementById('g-likes').innerText = data.like_count || 0;
                document.getElementById('g-dislikes').innerText = data.dislike_count || 0;
            } catch (err) {
                console.error('Error fetching reactions:', err);
            }
        }

        async function fetchComments(reportId) {
            const list = document.getElementById('g-comments-list');
            list.innerHTML = '<div style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">Loading comments...</div>';

            try {
                const res = await fetch(`${API_BASE_URL}/api/reports/${encodeURIComponent(reportId)}/comments`);
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to fetch comments');
                }
                const comments = await res.json();

                list.innerHTML = '';
                if (comments.length === 0) {
                    list.innerHTML = '<div style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">No comments yet.</div>';
                } else {
                    comments.forEach(c => {
                        const fullName = (c.first_name && c.last_name) ? `${c.first_name} ${c.last_name}` : c.username;
                        const deptTag = c.department_name ? ` (${c.department_name})` : '';

                        const div = document.createElement('div');
                        div.style.padding = '0.5rem';
                        div.style.marginBottom = '0.5rem';
                        div.style.background = 'var(--bg-panel)';
                        div.style.borderRadius = '6px';
                        div.style.fontSize = '0.85rem';
                        div.innerHTML = `
                            <div style="font-weight: 600; color: var(--text-primary); display: flex; justify-content: space-between;">
                                <span>${fullName}${deptTag}</span>
                                <span style="font-weight: 400; color: var(--text-secondary); font-size: 0.75rem;">
                                    ${c.created_at ? new Date(c.created_at).toLocaleString('en-US', { timeZone: 'Asia/Manila', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'Just now'}
                                </span>
                            </div>
                            <div style="color: var(--text-secondary); margin-top: 0.25rem;">${c.body}</div>
                        `;
                        list.appendChild(div);
                    });
                    list.scrollTop = list.scrollHeight;
                }
            } catch (err) {
                list.innerHTML = `<div style="padding: 0.5rem; color: #ef4444; font-size: 0.85rem;">Error: ${err.message}</div>`;
            }
        }

        window.postComment = async function () {
            const input = document.getElementById('g-comment-input');
            const body = input.value.trim();
            if (!body) return;

            // Get user info
            let userId = 1; // Default
            try {
                const user = JSON.parse(localStorage.getItem('user_token'));
                if (user && user.id) userId = user.id;
            } catch (e) { }

            try {
                const res = await fetch(`${API_BASE_URL}/api/reports/${encodeURIComponent(currentIssueId)}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ body: body, userId: userId })
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to post comment');
                }
                input.value = '';
                fetchComments(currentIssueId);
            } catch (err) {
                alert('Comment Error: ' + err.message);
            }
        }

        window.moderateIssue = async function (newPostStatus) {
            if (!confirm(`Are you sure you want to ${newPostStatus} this issue?`)) return;

            // 1. Disable buttons to prevent double-click
            const btnApprove = document.querySelector('.btn-approve');
            const btnDecline = document.querySelector('.btn-decline');
            if (btnApprove) btnApprove.disabled = true;
            if (btnDecline) btnDecline.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/api/reports/${encodeURIComponent(currentIssueId)}/post-status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newPostStatus.toLowerCase() })
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    // If already moderated, alert but refresh
                    if (res.status === 400) {
                        alert(`Notice: ${errData.error || 'This report has already been processed.'}`);
                        closeGlobalModal();
                        const iframe = document.getElementById('content-frame');
                        if (iframe && iframe.contentWindow && iframe.contentWindow.fetchIssues) {
                            iframe.contentWindow.fetchIssues();
                        }
                        return;
                    }
                    throw new Error(errData.error || 'Failed to update status');
                }

                const postStatusEl = document.getElementById('g-post-status');
                postStatusEl.innerText = newPostStatus;
                if (newPostStatus.toLowerCase() === 'approved') postStatusEl.style.color = '#10b981';
                else if (newPostStatus.toLowerCase() === 'rejected') postStatusEl.style.color = '#ef4444';

                alert(`Issue has been ${newPostStatus}.`);

                // Update modal buttons to hide the moderation card
                const statusEl = document.getElementById('g-status');
                updateModalButtons(statusEl.innerText, newPostStatus);

                // Refresh Iframe list
                const iframe = document.getElementById('content-frame');
                if (iframe && iframe.contentWindow && iframe.contentWindow.fetchIssues) {
                    iframe.contentWindow.fetchIssues();
                }
            } catch (err) {
                alert('Moderation Error: ' + err.message);
                // Re-enable if it failed
                if (btnApprove) btnApprove.disabled = false;
                if (btnDecline) btnDecline.disabled = false;
            }
        }

        function applyStatusColor(el, status) {
            if (status === 'Critical' || status === 'Error') el.style.color = '#ef4444';
            else if (status === 'Resolved' || status === 'Completed') el.style.color = '#10b981';
            else if (status === 'Ongoing' || status === 'In Review') el.style.color = '#f59e0b';
            else el.style.color = '#1e293b';
        }

        function updateModalButtons(status, postStatus) {
            const modCard = document.getElementById('admin-moderation-card');
            const respondSection = document.getElementById('respond-section');
            const btnComplete = document.getElementById('btn-mark-completed');

            // 1. Moderation Panel Visibility
            const ps = (postStatus || '').toLowerCase().trim();
            // Only show moderation card if it's truly pending
            if (ps === 'pending' || ps === '') {
                modCard.style.display = 'block';
            } else {
                modCard.style.display = 'none';
            }

            // 2. Response & Completion Section Visibility
            // Normalizing status to match cases
            const s = (status || '').toLowerCase();

            if (s === 'pending' || s === 'in review' || s === 'critical' || s === 'error') {
                respondSection.style.display = 'flex';
                btnComplete.style.display = 'none';
            } else if (s === 'ongoing' || s === 'in progress') {
                respondSection.style.display = 'none';
                btnComplete.style.display = 'block';
            } else {
                // Resolved or something else
                respondSection.style.display = 'none';
                btnComplete.style.display = 'none';
            }
        }

        window.handleRespond = function () {
            const dateInput = document.getElementById('response-date');
            const timeInput = document.getElementById('response-time');
            if (!dateInput.value) {
                alert("Please select a date to schedule this response.");
                return;
            }

            saveSchedule(currentIssueId, currentIssueName, dateInput.value, timeInput.value, 'Ongoing');
            updateStatusInDB(currentIssueId, 'In Progress'); // Sync with DB
            updateIssueStatus('Ongoing');
        }

        async function updateStatusInDB(reportId, dbStatus) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/reports/${encodeURIComponent(reportId)}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: dbStatus })
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    console.error('Failed to sync status to DB:', errData.error || res.statusText);
                }
            } catch (e) {
                console.error('Failed to sync status to DB:', e);
            }
        }

        window.deleteIssue = async function () {
            if (!currentIssueId) return;
            if (!confirm(`Are you sure you want to delete report ${currentIssueId}?`)) return;

            try {
                const res = await fetch(`${API_BASE_URL}/api/reports/${encodeURIComponent(currentIssueId)}`, {
                    method: 'DELETE'
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to delete report');
                }

                alert('Report deleted successfully.');
                closeGlobalModal();

                // Refresh iframe
                const iframe = document.getElementById('content-frame');
                if (iframe && iframe.contentWindow && iframe.contentWindow.fetchIssues) {
                    iframe.contentWindow.fetchIssues();
                }
            } catch (err) {
                alert('Error deleting report: ' + err.message);
            }
        }

        window.updateIssueStatus = function (newStatus) {
            console.log('Changing status for ID:', currentIssueId, 'to:', newStatus);
            const statusEl = document.getElementById('g-status');
            statusEl.innerText = newStatus;
            applyStatusColor(statusEl, newStatus);

            // Sync with Database
            updateStatusInDB(currentIssueId, newStatus);

            const iframe = document.getElementById('content-frame');
            if (iframe && iframe.contentWindow && iframe.contentWindow.updateRowStatus) {
                iframe.contentWindow.updateRowStatus(currentIssueId, newStatus);
            }
        }

        window.resolveAndRedirect = function (id, title, reporter, date, status, desc) {
            closeCriticalIssuesModal();

            // Redirect to Issues Page
            const iframe = document.getElementById('content-frame');
            iframe.src = 'pages/issues/view.html';

            // Wait for iframe to load then highlight
            iframe.onload = function () {
                if (iframe.contentWindow && iframe.contentWindow.highlightRow) {
                    iframe.contentWindow.highlightRow(id);
                }
                // Also open the modal
                openGlobalModal({ id, name: title, reporter, date, status, desc });

                // Remove listener to avoid duplicate triggers
                iframe.onload = null;
            };

            // Update Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => {
                if (el.getAttribute('onclick') && el.getAttribute('onclick').includes('issues')) {
                    el.classList.add('active');
                }
            });
        }

        window.closeGlobalModal = function () {
            globalModal.classList.remove('active');
            currentIssueId = null;

            // Clear highlight in iframe if it exists
            const iframe = document.getElementById('content-frame');
            if (iframe && iframe.contentWindow && iframe.contentWindow.clearHighlight) {
                iframe.contentWindow.clearHighlight();
            }
        }

        globalModal.addEventListener('click', (e) => {
            if (e.target === globalModal) {
                closeGlobalModal();
            }
        });

        // --- GLOBAL DAY MODAL LOGIC (Schedules) ---
        const dayModal = document.getElementById('dayModal');
        let currentSelectedDate = null;
        let activeFilter = 'All';

        window.openDayModal = function (dateString) {
            currentSelectedDate = dateString;
            // Format date for title
            const dateObj = new Date(dateString);
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('selectedDateTitle').innerText = formattedDate;

            filterTime('All'); // Reset filter ui
            document.querySelectorAll('.time-filter-btn').forEach(b => {
                b.classList.remove('active');
                if (b.innerText === 'All Day') b.classList.add('active');
            });

            dayModal.classList.add('active');
        }

        window.closeDayModal = function () {
            dayModal.classList.remove('active');
        }

        window.filterTime = function (time, btn) {
            activeFilter = time;
            if (btn) {
                document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            renderDayEvents();
        }

        function renderDayEvents() {
            const list = document.getElementById('dayEventsList');
            list.innerHTML = '';

            // Load schedules from localStorage
            let schedules = [];
            try {
                schedules = JSON.parse(localStorage.getItem('adminSchedules') || '[]');
            } catch (e) {
                schedules = [];
            }

            const events = schedules.filter(s => s.date === currentSelectedDate);

            if (events.length === 0) {
                list.innerHTML = `<div style="text-align: center; color: #94a3b8; padding: 2rem;">No responses for this day.</div>`;
                return;
            }

            events.forEach(ev => {
                // Simulate time (since data lacks it)
                let timeStr, timeOfDay;

                if (ev.time) {
                    const [h, m] = ev.time.split(':').map(Number);
                    const isAm = h < 12;
                    const amPm = isAm ? 'AM' : 'PM';
                    const displayHour = h % 12 || 12; // 0 becomes 12
                    timeStr = `${displayHour}:${m.toString().padStart(2, '0')} ${amPm}`;
                    timeOfDay = h < 12 ? 'Morning' : 'Afternoon';
                } else {
                    // Fallback for old data
                    const idNum = parseInt(ev.id.replace('#', '')) || 0;
                    const hour = (idNum % 12) + 8; // Random hour 8am-8pm
                    const isAm = hour < 12;
                    const amPm = isAm ? 'AM' : 'PM';
                    const displayHour = hour > 12 ? hour - 12 : hour;
                    timeOfDay = isAm ? 'Morning' : 'Afternoon';
                    timeStr = `${displayHour}:00 ${amPm}`;
                }

                if (activeFilter === 'All' || activeFilter === timeOfDay) {
                    const item = document.createElement('div');
                    item.className = 'day-event-item';
                    item.innerHTML = `
                         <div class="event-time">${timeStr}</div>
                         <div class="event-info">
                            <div class="event-name">${ev.name}</div>
                            <div class="event-status" style="text-transform: capitalize;">${ev.status}  ID: ${ev.id}</div>
                         </div>
                    `;
                    list.appendChild(item);
                }
            });

            if (list.innerHTML === '') {
                list.innerHTML = `<div style="text-align: center; color: #94a3b8; padding: 2rem;">No events in the ${activeFilter}.</div>`;
            }
        }

        dayModal.addEventListener('click', (e) => {
            if (e.target === dayModal) {
                closeDayModal();
            }
        });

        window.openSecurityModal = function () {
            securityModal.classList.add('active');
            lucide.createIcons(); // Refresh icons inside modal
        }

        window.closeSecurityModal = function () {
            securityModal.classList.remove('active');
        }

        window.switchSecTab = function (tabName, btn) {
            // Update Sidebar
            document.querySelectorAll('.sec-nav-item').forEach(i => i.classList.remove('active'));
            if (btn) btn.classList.add('active');

            // Update View
            document.querySelectorAll('.sec-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`sec-view-${tabName}`).classList.add('active');
        }

        window.searchSecSave = function (msg) {
            alert(msg);
            closeSecurityModal();
        }

        securityModal.addEventListener('click', (e) => {
            if (e.target === securityModal) closeSecurityModal();
        });

        // --- APPEARANCE MODAL LOGIC ---
        const appearanceModal = document.getElementById('appearanceModal');
        let selectedThemeMode = 'light'; // Default

        window.openAppearanceModal = function () {
            // Load saved mode
            const savedMode = localStorage.getItem('adminThemeMode') || 'light';
            setThemeMode(savedMode);
            appearanceModal.classList.add('active');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.closeAppearanceModal = function () {
            appearanceModal.classList.remove('active');
        }

        appearanceModal.addEventListener('click', (e) => {
            if (e.target === appearanceModal) closeAppearanceModal();
        });

        window.setThemeMode = function (mode) {
            selectedThemeMode = mode;
            // UI Update
            document.querySelectorAll('.theme-mode-option').forEach(opt => opt.classList.remove('active'));
            if (mode === 'light') {
                const lightBtn = document.getElementById('mode-light');
                if (lightBtn) {
                    lightBtn.classList.add('active');
                    lightBtn.style.borderColor = '#6366f1';
                    lightBtn.style.backgroundColor = 'rgba(99, 102, 241, 0.05)';
                }
                const darkBtn = document.getElementById('mode-dark');
                if (darkBtn) {
                    darkBtn.style.borderColor = '#e2e8f0';
                    darkBtn.style.backgroundColor = '#0f172a';
                }
            } else {
                const darkBtn = document.getElementById('mode-dark');
                if (darkBtn) {
                    darkBtn.classList.add('active');
                    darkBtn.style.borderColor = '#6366f1';
                    darkBtn.style.backgroundColor = '#1e293b';
                }
                const lightBtn = document.getElementById('mode-light');
                if (lightBtn) {
                    lightBtn.style.borderColor = '#e2e8f0';
                    lightBtn.style.backgroundColor = 'transparent';
                }
            }
        }

        window.saveAppearance = function () {
            localStorage.setItem('adminThemeMode', selectedThemeMode);

            // Apply to Root
            if (selectedThemeMode === 'dark') {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }

            // Also apply to iframe if possible
            const iframe = document.getElementById('content-frame');
            if (iframe && iframe.contentDocument) {
                if (selectedThemeMode === 'dark') {
                    iframe.contentDocument.documentElement.classList.add('dark-mode');
                } else {
                    iframe.contentDocument.documentElement.classList.remove('dark-mode');
                }
            }

            alert('Theme settings saved!');
            closeAppearanceModal();
        }

        // Apply theme on load
        const savedThemeMode = localStorage.getItem('adminThemeMode');
        if (savedThemeMode === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }

        window.handleNotifClick = function (id, title, reporter, status, date) {
            // Close dropdowns
            const notifDropdown = document.getElementById('notif-dropdown');
            const notifBtn = document.getElementById('notif-btn');
            if (notifDropdown) notifDropdown.classList.remove('active');
            if (notifBtn) notifBtn.classList.remove('active');

            // Switch to Issues Page
            const issuesNav = document.querySelector('.nav-item[data-page="issues"]');
            if (issuesNav) issuesNav.click();

            // Open Modal after delay
            setTimeout(() => {
                openGlobalModal({ id, name: title, reporter, date, status, desc: 'Reported via Notification System' });
            }, 300);
        }

        // --- CHAT WIDGET LOGIC ---
        let conversations = [
            {
                id: 1,
                name: "James Paul Silayan",
                avatar: "JS",
                lastMsg: "hoyyyy",
                time: "2m",
                unread: true,
                archived: false,
                messages: [
                    { text: "hoyyyy", sender: "them", time: "2 mins ago" }
                ]
            },
            {
                id: 2,
                name: "John Vitor Vetvet",
                avatar: "JV",
                lastMsg: "na flat akong motor naay bangag ang kalsada",
                time: "15m",
                unread: true,
                archived: false,
                messages: [
                    { text: "na flat akong motor naay bangag ang kalsada", sender: "them", time: "15 mins ago" }
                ]
            },
            {
                id: 3,
                name: "Khristian Dove",
                avatar: "KD",
                lastMsg: "nabangaan ko ug van",
                time: "1h",
                unread: true,
                archived: false,
                messages: [
                    { text: "nabangaan ko ug van", sender: "them", time: "1 hour ago" }
                ]
            },
            {
                id: 4,
                name: "Paolo Malavar",
                avatar: "PM",
                lastMsg: "natagak akoang panty sa may kanto",
                time: "3h",
                unread: false,
                archived: false,
                messages: [
                    { text: "natagak akoang panty sa may kanto", sender: "them", time: "3 hours ago" }
                ]
            },
            {
                id: 5,
                name: "Whiskey Itable",
                avatar: "WI",
                lastMsg: "walay kurenti diri dol",
                time: "5h",
                unread: false,
                archived: false,
                messages: [
                    { text: "walay kurenti diri dol", sender: "them", time: "5 hours ago" }
                ]
            },
            {
                id: 6,
                name: "Elmer Solayao",
                avatar: "ES",
                lastMsg: "tamvike nanamn",
                time: "1d",
                unread: false,
                archived: true,
                messages: [
                    { text: "tamvike nanamn", sender: "them", time: "Yesterday" }
                ]
            }
        ];

        let activeChatId = null;
        let currentFilter = 'all';

        const chatBox = document.getElementById('chat-box');
        const chatBadge = document.getElementById('chat-count');

        function toggleChat() {
            chatBox.classList.toggle('active');
            if (chatBox.classList.contains('active')) {
                renderChatList();
            } else {
                document.querySelectorAll('.action-popup').forEach(p => p.classList.remove('active'));
                showChatList();
            }
        }

        function renderChatList() {
            const listContainer = document.getElementById('chat-list-container');
            listContainer.innerHTML = '';

            let filtered = conversations.filter(c => {
                if (currentFilter === 'unread') return c.unread && !c.archived;
                if (currentFilter === 'archived') return c.archived;
                return !c.archived;
            });

            const unreadCount = conversations.filter(c => c.unread && !c.archived).length;
            chatBadge.innerText = unreadCount;
            chatBadge.style.display = unreadCount > 0 ? 'flex' : 'none';

            if (filtered.length === 0) {
                listContainer.innerHTML = `<div style="padding: 2rem; text-align: center; color: #94a3b8; font-size: 0.9rem;">No messages found.</div>`;
                return;
            }

            filtered.forEach(chat => {
                const item = document.createElement('div');
                item.className = `chat-list-item ${chat.unread ? 'unread' : ''}`;
                item.onclick = (e) => {
                    if (!e.target.closest('.chat-actions-btn') && !e.target.closest('.action-popup')) {
                        openConversation(chat.id);
                    }
                };

                item.innerHTML = `
                    <div class="user-avatar">${chat.avatar}</div>
                    <div class="chat-info">
                        <div class="chat-name">
                            ${chat.name}
                            <span class="chat-time">${chat.time}</span>
                        </div>
                        <div class="chat-preview">${chat.lastMsg}</div>
                    </div>
                    <button class="chat-actions-btn" onclick="toggleActionMenu(${chat.id}, this)">
                        <i data-lucide="more-vertical" width="16"></i>
                    </button>
                    <div class="action-popup" id="menu-${chat.id}">
                        <div class="action-option" onclick="handleAction('unread', ${chat.id})">
                             <i data-lucide="${chat.unread ? 'check' : 'message-circle'}" width="14"></i>
                             ${chat.unread ? 'Mark Read' : 'Mark Unread'}
                        </div>
                        <div class="action-option" onclick="handleAction('archive', ${chat.id})">
                             <i data-lucide="${chat.archived ? 'rotate-ccw' : 'archive'}" width="14"></i>
                             ${chat.archived ? 'Unarchive' : 'Archive'}
                        </div>
                        <div class="action-option delete" onclick="handleAction('delete', ${chat.id})">
                             <i data-lucide="trash-2" width="14"></i> Delete
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
        }

        function filterChats(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderChatList();
        }

        function toggleActionMenu(id, btn) {
            const menu = document.getElementById(`menu-${id}`);
            document.querySelectorAll('.action-popup').forEach(p => {
                if (p.id !== `menu-${id}`) p.classList.remove('active');
            });
            menu.classList.toggle('active');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-actions-btn') && !e.target.closest('.action-popup')) {
                document.querySelectorAll('.action-popup').forEach(p => p.classList.remove('active'));
            }
        });

        function handleAction(action, id) {
            const chat = conversations.find(c => c.id === id);
            if (!chat) return;

            if (action === 'unread') {
                chat.unread = !chat.unread;
            } else if (action === 'archive') {
                chat.archived = !chat.archived;
            } else if (action === 'delete') {
                conversations = conversations.filter(c => c.id !== id);
            }
            renderChatList();
        }

        function openConversation(id) {
            const chat = conversations.find(c => c.id === id);
            if (!chat) return;

            activeChatId = id;
            if (chat.unread) {
                chat.unread = false;
                renderChatList();
            }

            document.getElementById('chat-view-list').style.display = 'none';
            document.getElementById('chat-view-convo').style.display = 'flex';
            document.getElementById('active-chat-name').innerText = chat.name;

            const msgsBody = document.getElementById('chat-msgs');
            msgsBody.innerHTML = '';

            chat.messages.forEach(msg => {
                const bubble = document.createElement('div');
                bubble.className = `msg-bubble msg-${msg.sender === 'me' ? 'out' : 'in'}`;
                bubble.innerHTML = `${msg.text}<div class="msg-meta">${msg.sender === 'me' ? 'You' : chat.name}  ${msg.time}</div>`;
                msgsBody.appendChild(bubble);
            });
            msgsBody.scrollTop = msgsBody.scrollHeight;
        }

        function showChatList() {
            document.getElementById('chat-view-convo').style.display = 'none';
            document.getElementById('chat-view-list').style.display = 'flex';
            activeChatId = null;
            renderChatList();
        }

        function handleChat(e) {
            if (e.key === 'Enter') sendChat();
        }

        function sendChat() {
            const input = document.getElementById('chat-txt');
            const msgText = input.value.trim();
            if (!msgText || !activeChatId) return;

            const chat = conversations.find(c => c.id === activeChatId);

            chat.messages.push({ text: msgText, sender: 'me', time: 'Just now' });
            chat.lastMsg = "You: " + msgText;
            chat.time = "Now";

            const body = document.getElementById('chat-msgs');
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble msg-out';
            bubble.innerHTML = `${msgText}<div class="msg-meta">You  Just now</div>`;
            body.appendChild(bubble);
            input.value = '';
            body.scrollTop = body.scrollHeight;

            setTimeout(() => {
                if (activeChatId === chat.id) {
                    const replyText = "Thanks for the update!";
                    chat.messages.push({ text: replyText, sender: 'them', time: 'Just now' });
                    chat.lastMsg = replyText;

                    const reply = document.createElement('div');
                    reply.className = 'msg-bubble msg-in';
                    reply.innerHTML = `${replyText}<div class="msg-meta">${chat.name}  Just now</div>`;
                    body.appendChild(reply);
                    body.scrollTop = body.scrollHeight;
                }
            }, 2000);
        }
    </script>
    <script>
        // Ensure iframe gets the theme on load
        document.getElementById('content-frame').addEventListener('load', function () {
            const savedThemeMode = localStorage.getItem('adminThemeMode');
            if (savedThemeMode === 'dark' && this.contentDocument) {
                this.contentDocument.documentElement.classList.add('dark-mode');
            }
        });
    </script>
    <script src="js/sidebar.js"></script>
    <script src="js/router.js"></script>
    <!-- Ongoing Schedules Modal -->
    <div class="modal-overlay" id="allSchedulesModal" style="z-index: 2400;">
        <div class="modal-card" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="activity" width="24" style="color: #6366f1;"></i>
                    Ongoing Schedules Monitor
                </h2>
                <button class="modal-close" onclick="closeAllSchedulesModal()">&times;</button>
            </div>

            <div class="modal-body"
                style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 0;">
                <!-- Filter Bar -->
                <div
                    style="padding: 1rem; border-bottom: 1px solid var(--border-color); background: var(--bg-panel); display: flex; gap: 1rem;">
                    <input type="text" id="sched-search" placeholder="Search by name or ID..."
                        onkeyup="renderAllSchedules()"
                        style="flex: 1; padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary); font-family: inherit;">
                    <select id="sched-filter-status" onchange="renderAllSchedules()"
                        style="padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary); font-family: inherit;">
                        <option value="Ongoing">Ongoing</option>
                        <option value="All">All Statuses</option>
                    </select>
                </div>

                <!-- List/Table -->
                <div style="flex: 1; overflow-y: auto; padding: 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: var(--bg-panel); position: sticky; top: 0; z-index: 10;">
                            <tr style="text-align: left; color: var(--text-secondary); font-size: 0.85rem;">
                                <th style="padding: 1rem; border-bottom: 1px solid var(--border-color);">ID</th>
                                <th style="padding: 1rem; border-bottom: 1px solid var(--border-color);">Issue Name</th>
                                <th style="padding: 1rem; border-bottom: 1px solid var(--border-color);">Date</th>
                                <th style="padding: 1rem; border-bottom: 1px solid var(--border-color);">Time</th>
                                <th style="padding: 1rem; border-bottom: 1px solid var(--border-color);">Status</th>
                            </tr>
                        </thead>
                        <tbody id="all-schedules-list">
                            <!-- Items -->
                        </tbody>
                    </table>
                    <div id="no-schedules-msg"
                        style="text-align: center; padding: 2rem; color: var(--text-secondary); display: none;">No
                        schedules found.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.openAllSchedulesModal = function () {
            renderAllSchedules();
            document.getElementById('allSchedulesModal').classList.add('active');
            lucide.createIcons();
        }

        window.closeAllSchedulesModal = function () {
            document.getElementById('allSchedulesModal').classList.remove('active');
        }

        window.renderAllSchedules = function () {
            const list = document.getElementById('all-schedules-list');
            const noMsg = document.getElementById('no-schedules-msg');
            const search = document.getElementById('sched-search').value.toLowerCase();
            const statusFilter = document.getElementById('sched-filter-status').value;

            list.innerHTML = '';
            let schedules = JSON.parse(localStorage.getItem('adminSchedules') || '[]');

            // Filter
            const filtered = schedules.filter(s => {
                const matchesStatus = statusFilter === 'All' || s.status === statusFilter;
                const matchesSearch = s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search);
                return matchesStatus && matchesSearch;
            });

            if (filtered.length === 0) {
                noMsg.style.display = 'block';
            } else {
                noMsg.style.display = 'none';
                filtered.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid var(--border-color)';
                    tr.style.transition = 'background 0.2s';
                    tr.onmouseover = function () { this.style.background = 'var(--bg-panel)'; };
                    tr.onmouseout = function () { this.style.background = 'transparent'; };

                    // Parse Time (reuse logic)
                    let timeStr = 'N/A';
                    if (s.time) {
                        const [h, m] = s.time.split(':');
                        const hh = parseInt(h);
                        const amPm = hh < 12 ? 'AM' : 'PM';
                        const displayH = hh % 12 || 12;
                        timeStr = `${displayH}:${m} ${amPm}`;
                    }

                    // Format Date
                    let dateStr = s.date;
                    try {
                        const d = new Date(s.date);
                        dateStr = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    } catch (e) { }

                    // Status Color
                    let statusColor = '#94a3b8';
                    if (s.status === 'Ongoing') statusColor = '#f59e0b';
                    if (s.status === 'Resolved' || s.status === 'Completed') statusColor = '#10b981';
                    if (s.status === 'Critical') statusColor = '#ef4444';

                    tr.innerHTML = `
                        <td style="padding: 1rem; color: var(--text-primary); font-weight: 500;">${s.id}</td>
                        <td style="padding: 1rem; color: var(--text-primary);">${s.name}</td>
                        <td style="padding: 1rem; color: var(--text-secondary);">${dateStr}</td>
                        <td style="padding: 1rem; color: var(--text-secondary);">${timeStr}</td>
                        <td style="padding: 1rem;"><span style="color: ${statusColor}; font-weight: 500; background: ${statusColor}20; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${s.status}</span></td>
                    `;
                    list.appendChild(tr);
                });
            }
        }
    </script>
    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal" style="z-index: 9999;">
        <div class="modal-card"
            style="width: 320px; max-width: 90%; text-align: center; padding: 1.5rem; border-radius: 12px; margin: auto; background: var(--bg-modal);">
            <div style="margin-bottom: 1rem;">
                <div
                    style="width: 48px; height: 48px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 1px solid rgba(239, 68, 68, 0.2);">
                    <i data-lucide="log-out" width="24"></i>
                </div>
            </div>
            <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--text-primary); font-weight: 600;">Sign Out
            </h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem; line-height: 1.4;">Are you
                sure you want to log out?</p>
            <div style="display: flex; gap: 0.75rem; justify-content: center;">
                <button onclick="closeLogoutModal()"
                    style="flex: 1; padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background 0.2s;"
                    onmouseover="this.style.background='var(--bg-panel)'"
                    onmouseout="this.style.background='transparent'">
                    Cancel
                </button>
                <button onclick="performLogout()"
                    style="flex: 1; padding: 0.6rem; border-radius: 6px; border: none; background: #ef4444; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: background 0.2s;"
                    onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <script>
            (function () {
                // Logout Logic
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function () {
                        // Close dropdown if open
                        const dropdown = document.getElementById('profile-dropdown');
                        if (dropdown) dropdown.classList.remove('active');

                        // Open Modal
                        document.getElementById('logoutModal').classList.add('active');
                        if (window.lucide) lucide.createIcons();
                    });
                }

                window.closeLogoutModal = function () {
                    document.getElementById('logoutModal').classList.remove('active');
                }

                window.performLogout = function () {
                    // Clear any session data if needed
                    // localStorage.removeItem('adminThemeMode'); // Optional: keep theme?

                    // Redirect
                    window.location.href = '../admin-login/index.html';
                }

                // Profile Modal Functions
                window.openProfileModal = async function () {
                    window.selectedProfileFile = null; // Reset selection
                    const modal = document.getElementById('profileModal');
                    modal.classList.add('active');

                    // Load user data
                    await loadProfileData();
                    lucide.createIcons();
                }

                window.closeProfileModal = function () {
                    document.getElementById('profileModal').classList.remove('active');
                }

                window.loadProfileData = async function () {
                    try {
                        const user = JSON.parse(localStorage.getItem('user_token') || '{}');

                        // Set basic fields from localStorage
                        document.getElementById('p-name').value = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Admin User';
                        document.getElementById('p-username').value = user.username || '';
                        document.getElementById('p-email').value = user.email || '';

                        // Fetch full user data including department from API
                        const API_BASE_URL = window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:'
                            ? 'http://localhost:3000'
                            : '';

                        const response = await fetch(`${API_BASE_URL}/api/users/admins?department_id=${user.department_id || ''}`);
                        const admins = await response.json();
                        const currentUser = admins.find(a => a.id === user.id);

                        if (currentUser) {
                            // Update department field
                            document.getElementById('p-department').value = currentUser.department_name || 'Not Assigned';

                            // Update profile photo if available
                            if (currentUser.profile_photo) {
                                const previewImg = document.getElementById('preview-avatar');
                                const defaultIcon = document.getElementById('default-avatar-icon');
                                previewImg.src = currentUser.profile_photo;
                                previewImg.style.display = 'block';
                                defaultIcon.style.display = 'none';
                            }
                        }
                    } catch (error) {
                        console.error('Error loading profile data:', error);
                    }
                }

                window.selectedProfileFile = null; // Store the file object

                window.handleImageUpload = function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        window.selectedProfileFile = file; // Save for upload
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const previewImg = document.getElementById('preview-avatar');
                            const defaultIcon = document.getElementById('default-avatar-icon');
                            previewImg.src = e.target.result;
                            previewImg.style.display = 'block';
                            defaultIcon.style.display = 'none';
                        };
                        reader.readAsDataURL(file);
                    }
                }

                window.saveProfile = async function (event) {
                    event.preventDefault(); // Good practice even for type="button" to stop propagation
                    console.log('saveProfile called');

                    let saveBtn = event.target;
                    // Ensure we have the button if clicked on inner text
                    if (saveBtn.tagName !== 'BUTTON') {
                        saveBtn = saveBtn.closest('button');
                    }

                    const originalBtnText = saveBtn.innerText;
                    saveBtn.innerText = "Saving...";
                    saveBtn.disabled = true;

                    try {
                        const user = JSON.parse(localStorage.getItem('user_token') || '{}');
                        if (!user.id) throw new Error('User ID not found. Please relogin.');

                        const fullName = document.getElementById('p-name').value.trim();
                        const [firstName, ...lastNameParts] = fullName.split(' ');
                        const lastName = lastNameParts.join(' ');

                        // Determine API URL dynamically based on current host
                        // Use 127.0.0.1 fallback if file:// or empty
                        const hostname = window.location.hostname || '127.0.0.1';
                        // Keep http protocol unless https is used
                        const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';

                        const API_BASE_URL = `${protocol}//${hostname}:3000`;
                        console.log('Using API Base URL:', API_BASE_URL);

                        // 1. Handle Image Upload if exists
                        let uploadedPhotoUrl = null;
                        if (window.selectedProfileFile) {
                            console.log('Starting image upload...');
                            const formData = new FormData();
                            formData.append('image', window.selectedProfileFile);

                            try {
                                const uploadRes = await fetch(`${API_BASE_URL}/api/upload/avatar`, {
                                    method: 'POST',
                                    body: formData
                                });

                                if (!uploadRes.ok) {
                                    const errText = await uploadRes.text();
                                    throw new Error(`Upload failed (${uploadRes.status}): ${errText}`);
                                }

                                const uploadData = await uploadRes.json();
                                uploadedPhotoUrl = uploadData.url;
                                console.log('Image uploaded successfully:', uploadedPhotoUrl);
                            } catch (uploadErr) {
                                console.error('Image Upload Error:', uploadErr);
                                throw new Error('Image upload failed: ' + uploadErr.message);
                            }
                        }

                        // 2. Update Profile Data
                        console.log('Updating profile data...');
                        const updatedData = {
                            first_name: firstName || '',
                            last_name: lastName || '',
                            username: document.getElementById('p-username').value.trim(),
                            email: document.getElementById('p-email').value.trim()
                        };

                        if (uploadedPhotoUrl) {
                            updatedData.profile_photo = uploadedPhotoUrl;
                        }

                        const response = await fetch(`${API_BASE_URL}/api/users/${user.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updatedData)
                        });

                        if (response.ok) {
                            // Update localStorage
                            user.firstName = firstName;
                            user.lastName = lastName;
                            user.username = updatedData.username;
                            user.email = updatedData.email;
                            if (uploadedPhotoUrl) {
                                user.profile_photo = uploadedPhotoUrl;
                                // Force update current avatar images in UI
                                // Force update current avatar images in UI header
                                const avatarBtn = document.getElementById('avatar-btn');
                                if (avatarBtn) {
                                    avatarBtn.innerHTML = `<img src="${uploadedPhotoUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                                }
                            }
                            localStorage.setItem('user_token', JSON.stringify(user));

                            alert('Profile updated successfully!');
                            closeProfileModal();
                        } else {
                            const error = await response.json();
                            throw new Error('Update failed: ' + (error.error || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error in saveProfile:', error);
                        alert(error.message);
                    } finally {
                        saveBtn.innerText = originalBtnText;
                        saveBtn.disabled = false;
                        window.selectedProfileFile = null;
                    }
                }

                // Security Modal Functions
                window.openSecurityModal = async function () {
                    const modal = document.getElementById('securityModal');
                    modal.classList.add('active');

                    // Load current email
                    await loadSecurityData();
                    lucide.createIcons();
                }

                window.closeSecurityModal = function () {
                    document.getElementById('securityModal').classList.remove('active');

                    // Clear password fields for security
                    document.getElementById('sec-current-password').value = '';
                    document.getElementById('sec-new-password').value = '';
                    document.getElementById('sec-confirm-password').value = '';
                }

                window.loadSecurityData = async function () {
                    try {
                        const user = JSON.parse(localStorage.getItem('user_token') || '{}');

                        // Set current email
                        document.getElementById('sec-current-email').value = user.email || 'Not set';
                    } catch (error) {
                        console.error('Error loading security data:', error);
                    }
                }

                window.updatePassword = async function () {
                    const currentPassword = document.getElementById('sec-current-password').value.trim();
                    const newPassword = document.getElementById('sec-new-password').value.trim();
                    const confirmPassword = document.getElementById('sec-confirm-password').value.trim();

                    // Validation
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        alert('Please fill in all password fields');
                        return;
                    }

                    if (newPassword.length < 8) {
                        alert('New password must be at least 8 characters long');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match');
                        return;
                    }

                    try {
                        const user = JSON.parse(localStorage.getItem('user_token') || '{}');

                        const API_BASE_URL = window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:'
                            ? 'http://localhost:3000'
                            : '';

                        const response = await fetch(`${API_BASE_URL}/api/users/${user.id}/password`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                currentPassword: currentPassword,
                                newPassword: newPassword
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            alert('Password updated successfully!');
                            // Clear fields
                            document.getElementById('sec-current-password').value = '';
                            document.getElementById('sec-new-password').value = '';
                            document.getElementById('sec-confirm-password').value = '';
                        } else {
                            alert('Error: ' + (data.error || 'Failed to update password'));
                        }
                    } catch (error) {
                        console.error('Error updating password:', error);
                        alert('Error updating password. Please try again.');
                    }
                }

                window.updateEmail = async function () {
                    const newEmail = document.getElementById('sec-new-email').value.trim();

                    if (!newEmail) {
                        alert('Please enter a new email address');
                        return;
                    }

                    // Basic email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(newEmail)) {
                        alert('Please enter a valid email address');
                        return;
                    }

                    try {
                        const user = JSON.parse(localStorage.getItem('user_token') || '{}');

                        const API_BASE_URL = window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:'
                            ? 'http://localhost:3000'
                            : '';

                        const response = await fetch(`${API_BASE_URL}/api/users/${user.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: newEmail
                            })
                        });

                        if (response.ok) {
                            // Update localStorage
                            user.email = newEmail;
                            localStorage.setItem('user_token', JSON.stringify(user));

                            // Update current email display
                            document.getElementById('sec-current-email').value = newEmail;
                            document.getElementById('sec-new-email').value = '';

                            alert('Email updated successfully!');
                        } else {
                            const error = await response.json();
                            alert('Error: ' + (error.error || 'Failed to update email'));
                        }
                    } catch (error) {
                        console.error('Error updating email:', error);
                        alert('Error updating email. Please try again.');
                    }
                }

                window.switchSecTab = function (tab, element) {
                    // Hide all views
                    document.querySelectorAll('.sec-view').forEach(v => v.classList.remove('active'));
                    document.querySelectorAll('.sec-nav-item').forEach(n => n.classList.remove('active'));

                    // Show selected view
                    document.getElementById('sec-view-' + tab).classList.add('active');
                    element.classList.add('active');

                    lucide.createIcons();
                }
            })();
    </script>
</body>

</html>