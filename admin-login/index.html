<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagum UYnite</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Animated Logo -->
    <div style="position: fixed; top: 30px; left: 30px; z-index: 100;">
        <lottie-player src="../admin-portal/assets/animations/SAS.json" background="transparent" speed="1"
            style="width: 50px; height: 50px; filter: brightness(0) invert(1);" loop autoplay></lottie-player>
    </div>

    <!-- Notification -->
    <div class="notification" id="notify-error">
        <i data-lucide="alert-circle" color="#ef4444"></i>
        <div>
            <div style="font-weight: 600; color: #1e293b;">Login Failed</div>
            <div style="font-size: 0.875rem; color: #64748b;">Invalid admin credentials.</div>
        </div>
    </div>

    <style>
        /* New Layout Overrides */
        body {
            background: url('images/tagom.png') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Left align */
            padding-left: 10%;
            /* Spacing from left */
        }

        /* Dark overlay for readability if needed, but design shows clear image */
        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        .login-card-new {
            width: 100%;
            max-width: 450px;
            color: white;
        }

        .login-header h1 {
            font-size: 2.5rem;
            font-weight: 500;
            /* Regular weight like image */
            margin-bottom: 0.25rem;
            letter-spacing: -0.5px;
        }

        .login-header p {
            font-size: 1.25rem;
            font-weight: 400;
            margin-bottom: 2.5rem;
            opacity: 0.9;
        }

        .custom-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .group-icon {
            font-size: 2rem;
            margin-right: 1.5rem;
            width: 32px;
            display: flex;
            justify-content: center;
        }

        .group-icon i {
            width: 32px;
            height: 32px;
            stroke-width: 1.5px;
        }

        .custom-pill-input {
            flex: 1;
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 999px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .custom-pill-input::placeholder {
            color: transparent;
            /* Image shows no placeholder or it's empty */
        }

        .custom-pill-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: white;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1);
        }

        /* Form Options Row: Remember Me & Forgot PW */
        .form-options-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: -0.5rem;
            margin-bottom: 2rem;
            color: white;
            font-size: 0.9rem;
        }

        /* Modern Checkbox */
        .custom-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 0.5rem;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .custom-checkbox:hover {
            opacity: 1;
        }

        .custom-checkbox input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            height: 18px;
            width: 18px;
            background-color: transparent;
            border: 2px solid rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .custom-checkbox input:checked~.checkmark {
            background-color: white;
            border-color: white;
        }

        .checkmark:after {
            content: "";
            display: none;
            width: 4px;
            height: 8px;
            border: solid black;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-top: -2px;
        }

        .custom-checkbox input:checked~.checkmark:after {
            display: block;
        }

        .forgot-link-new {
            color: white;
            opacity: 0.8;
            font-size: 0.9rem;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .forgot-link-new:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* Hidden login button to allow 'Enter' key submission, or visible heavily styled? 
           The reference image doesn't explicitly show a button, but users need one. 
           I'll add a subtly styled one or keep the pill theme. */
        .btn-hidden-submit {
            background: white;
            color: #0f172a;
            /* Dark text */
            border: none;
            padding: 1rem;
            border-radius: 999px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
            display: block;
            transition: all 0.2s;
            font-size: 1rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .btn-hidden-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.25);
        }

        .mobile-credits {
            position: fixed;
            bottom: 2rem;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            display: block;
            /* Show on all devices */
            z-index: 20;
        }

        /* Mobile */
        @media (max-width: 768px) {
            body {
                padding: 2rem;
                justify-content: center;
            }

            .login-card-new {
                width: 100%;
            }

            /* Hide branding on mobile */
            div[style*="position: fixed; right: 10%"] {
                display: none !important;
            }

            .mobile-credits {
                display: block;
            }
        }
    </style>

    <div class="login-card-new">
        <form id="login-form" onsubmit="handleLogin(event)">
            <div class="login-header">
                <h1>Welcome Back!</h1>
                <p>Sign in to your account</p>
            </div>

            <div class="custom-input-group">
                <div class="group-icon">
                    <i data-lucide="user"></i>
                </div>
                <input type="text" class="custom-pill-input" id="email" placeholder="Email or Username">
            </div>

            <div class="custom-input-group">
                <div class="group-icon">
                    <i data-lucide="lock"></i>
                </div>
                <div style="position: relative; flex: 1;">
                    <input type="password" class="custom-pill-input" id="password" placeholder="Password"
                        style="width: 100%; padding-right: 3rem;">
                    <button type="button" id="toggle-password-btn" onclick="togglePassword()"
                        style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.8; padding: 0;">
                        <i data-lucide="eye" width="20"></i>
                    </button>
                </div>
            </div>

            <div class="form-options-row">
                <label class="custom-checkbox">
                    <input type="checkbox">
                    <span class="checkmark"></span>
                    Remember me
                </label>
                <a href="#" onclick="toggleForgot(event)" class="forgot-link-new">Forgot password?</a>
            </div>

            <!-- Visible Submit for UX -->
            <button type="submit" class="btn-hidden-submit" id="login-btn">
                Sign In
            </button>
        </form>

        <!-- Forgot Password Form (Hidden) -->
        <form id="forgot-form" onsubmit="handleForgot(event)" style="display: none;">
            <div class="login-header">
                <h1>Recovery</h1>
                <p>Enter email to reset password</p>
            </div>

            <div class="custom-input-group">
                <div class="group-icon">
                    <i data-lucide="mail"></i>
                </div>
                <input type="email" class="custom-pill-input" id="reset-email" placeholder="Registered Email">
            </div>

            <button type="submit" class="btn-hidden-submit">Send Link</button>

            <div style="margin-top: 1.5rem;">
                <a href="#" onclick="toggleForgot(event)" class="forgot-link-new">Back to Login</a>
            </div>
        </form>
    </div>

    <!-- Right Side Branding -->
    <div style="position: fixed; right: 10%; top: 50%; transform: translateY(-50%); z-index: 10;">
        <img src="images/DARK.png" alt="Tagum UYnite"
            style="max-width: 400px; width: 100%; height: auto; display: block; user-select: none; -webkit-user-drag: none;"
            oncontextmenu="return false;" draggable="false">
    </div>

    <!-- Mobile Credits -->
    <div class="mobile-credits">
        &copy; 2025 Tagum Uynite
    </div>

    <script>
        lucide.createIcons();

        function togglePassword() {
            const input = document.getElementById('password');
            const btn = document.getElementById('toggle-password-btn');

            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<i data-lucide="eye-off" width="20"></i>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<i data-lucide="eye" width="20"></i>';
            }
            lucide.createIcons();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('login-btn');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const notify = document.getElementById('notify-error');
            const card = document.querySelector('.login-card-new');

            // Button Loading State
            const originalText = btn.innerHTML;
            btn.innerHTML = "Authenticating...";
            btn.style.opacity = "0.8";
            btn.disabled = true;

            try {
                // Determine API URL (handle local dev or production)
                const API_BASE_URL = (window.location.port === '5500' || window.location.port === '5501' || window.location.protocol === 'file:')
                    ? 'http://localhost:3000'
                    : '';

                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Check Role
                    const userRole = (data.user.role || '').toLowerCase();

                    // Allow both Admin and Technician (Super Admin)
                    if (userRole === 'admin' || userRole === 'technician') {
                        btn.innerHTML = "Success!";
                        btn.style.background = "#10b981";
                        btn.style.color = "white";

                        // Store user session
                        localStorage.setItem('user_token', JSON.stringify(data.user));

                        setTimeout(() => {
                            window.location.href = '../admin-portal/index.html';
                        }, 500);
                    } else {
                        throw new Error("Access Denied: You are not authorized.");
                    }
                } else {
                    throw new Error(data.error || 'Login failed');
                }

            } catch (err) {
                console.error(err);
                btn.innerHTML = originalText;
                btn.style.opacity = "1";
                btn.style.background = ""; // Reset
                btn.style.color = "";
                btn.disabled = false;

                // Show Error Notification
                notify.innerHTML = `
                    <i data-lucide="alert-circle" color="#ef4444"></i>
                    <div>
                        <div style="font-weight: 600; color: #1e293b;">Login Failed</div>
                        <div style="font-size: 0.875rem; color: #64748b;">${err.message}</div>
                    </div>
                `;
                lucide.createIcons();
                notify.classList.add('active');
                card.classList.add('shake');

                // Highlight inputs
                const emailInput = document.getElementById('email');
                const passInput = document.getElementById('password');
                if (emailInput) emailInput.style.borderColor = "#ef4444";
                if (passInput) passInput.style.borderColor = "#ef4444";

                setTimeout(() => {
                    notify.classList.remove('active');
                    card.classList.remove('shake');
                    if (emailInput) emailInput.style.borderColor = "rgba(255, 255, 255, 0.8)";
                    if (passInput) passInput.style.borderColor = "rgba(255, 255, 255, 0.8)";
                }, 3000);
            }
        }

        function toggleForgot(e) {
            e.preventDefault();
            const loginForm = document.getElementById('login-form');
            const forgotForm = document.getElementById('forgot-form');

            if (loginForm.style.display === 'none') {
                loginForm.style.display = 'block';
                forgotForm.style.display = 'none';
            } else {
                loginForm.style.display = 'none';
                forgotForm.style.display = 'block';
            }
        }

        function handleForgot(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            const notify = document.getElementById('notify-error');

            if (email && email.includes('@')) {
                notify.innerHTML = `
                    <i data-lucide="check-circle" color="#10b981"></i>
                    <div>
                        <div style="font-weight: 600; color: #1e293b;">Email Sent</div>
                        <div style="font-size: 0.875rem; color: #64748b;">Reset link sent to ${email}</div>
                    </div>
                `;
                notify.style.borderLeftColor = "#10b981";
                lucide.createIcons();
                notify.classList.add('active');

                setTimeout(() => {
                    toggleForgot(e);
                    notify.classList.remove('active');
                    notify.style.borderLeftColor = "#ef4444";
                }, 3000);
            }
        }
    </script>
</body>

</html>